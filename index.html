<!DOCTYPE html>
<html lang="en">
<head>
    
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1E293B">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9703/9703596.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARI Admin - Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">



    <style>
        
        /* --- PRO TITLES & HEADERS --- */
.pro-header { 
    display: flex; align-items: center; justify-content: space-between; 
    background: white; padding: 20px; border-radius: 20px; 
    border: 1px solid #F1F5F9; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
    margin-bottom: 24px;
}
.pro-title { font-weight: 800; font-size: 1.5rem; letter-spacing: -0.02em; color: #1E293B; }
.pro-subtitle { font-size: 0.875rem; color: #94A3B8; font-weight: 600; margin-top: 4px; }

/* --- SMOOTH DRAG ANIMATIONS --- */
/* The item being dragged (High Z-Index, Pop effect) */
.sortable-drag { 
    opacity: 1 !important; background: white !important; 
    transform: scale(1.05) rotate(2deg); 
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    cursor: grabbing !important; z-index: 9999;
}
/* The empty space where it will land */
.sortable-ghost { 
    opacity: 0.3; background: #F8FAFC; 
    border: 2px dashed #CBD5E1; border-radius: 16px; 
    transform: scale(0.95);
}
/* The item when you hold it but haven't moved yet */
.sortable-chosen {
    background: #FFF7ED;
}

/* --- ELEGANT INPUTS --- */
.input-box {
    width: 100%;
    padding: 14px 16px; /* Bigger padding for pro feel */
    background: #F8FAFC;
    border: 1px solid #E2E8F0;
    border-radius: 14px; /* Softer corners */
    outline: none;
    font-size: 14px;
    font-weight: 600;
    color: #334155;
    transition: all 0.2s;
}
.input-box::placeholder {
    color: #94A3B8;
    font-weight: 500;
}
.input-box:focus {
    border-color: #CBD5E1; /* Subtle focus border */
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03); /* Soft shadow on focus */
}

/* Custom Select Arrow */
select.input-box {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
}

/* Remove Image Button */
.btn-remove-img {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: all 0.2s;
    z-index: 20;
}
.btn-remove-img:hover { transform: scale(1.1); background: #EF4444; }


        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-card { background: white; border: 1px solid #E2E8F0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 16px; transition: transform 0.2s; }
        .input-box { width: 100%; padding: 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 12px; outline: none; font-size: 14px; transition: all 0.2s; }
        .input-box:focus { border-color: #FF5722; background: white; }
        .btn-main { background: #1E293B; color: white; font-weight: 700; padding: 12px 24px; border-radius: 12px; transition: all 0.2s; text-align: center; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-main:active { transform: scale(0.96); }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        /* Sidebar & Layout */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50; }
        .sidebar-open { transform: translateX(0) !important; }
        #sidebar-overlay { transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        .overlay-active { pointer-events: auto !important; opacity: 1 !important; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background-color: #F1F5F9; }
        .nav-item.active { background: linear-gradient(135deg, #FF5722 0%, #FF8A50 100%); color: white; box-shadow: 0 4px 12px rgba(255, 87, 34, 0.2); }
        
        /* Uploaders */
        .img-uploader { position: relative; border: 2px dashed #CBD5E1; border-radius: 16px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; background: #F8FAFC; transition: all 0.2s; }
        .img-uploader:hover { border-color: #FF5722; background: #FFF7ED; }
        
        /* Cropper Modal */
        #crop-modal { opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; }
        #crop-modal.active { opacity: 1; pointer-events: auto; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        
        /* Preloader */
        #preloader { position: fixed; inset: 0; background: #F8FAFC; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; pointer-events: none; }
        #preloader.loaded { opacity: 0; }
        
        /* Utilities */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .sortable-ghost { opacity: 0.4; background: #FFF7ED; border: 2px dashed #FF5722; }
        #toast-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 99999; pointer-events: none; }
        #toast-container.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden bg-slate-50">

    <div id="preloader"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div></div>
    
    <div id="crop-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-lg flex flex-col overflow-hidden shadow-2xl h-[70vh]">
            <div class="p-4 border-b flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-lg">Adjust Image</h3>
                <button onclick="closeCropper()" class="text-slate-400 hover:text-slate-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="flex-1 bg-slate-900 relative w-full overflow-hidden">
                <img id="crop-target" class="max-w-full max-h-full block">
            </div>
            <div class="p-4 border-t bg-white flex justify-end gap-3">
                <button onclick="finishCrop()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Save Crop</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3"><i class="fa-solid fa-circle-check text-green-400 text-lg"></i><span id="toast-msg" class="font-bold text-sm">Success</span></div>

    <div id="auth-overlay" class="fixed inset-0 bg-slate-900 z-[150] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-orange-100 rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl">üöõ</div>
            <h2 class="text-2xl font-black mb-2">Admin Portal</h2>
            <input type="email" id="admin-email" placeholder="Email" class="input-box mb-3"><input type="password" id="admin-pass" placeholder="Password" class="input-box mb-6"><button onclick="handleAdminLogin()" id="btn-unlock" class="btn-main w-full bg-orange-600 shadow-lg">Unlock</button>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-30 bg-slate-900/20 backdrop-blur-sm md:hidden"></div>
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-slate-100 flex flex-col z-50 transform -translate-x-full md:translate-x-0 md:relative shadow-2xl md:shadow-none">
        <div class="p-8 hidden md:block">
            <h1 class="text-3xl font-black">TARI<span class="text-orange-500">.</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">Admin Console</p>
            <div class="mt-6 flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                <span class="text-sm font-bold text-slate-600" id="store-status-text-d">Store Closed</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="store-toggle-d" class="sr-only peer" onchange="toggleStore(this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                </label>
            </div>
        </div>
        
        <div class="p-6 md:hidden flex justify-between items-center border-b border-slate-50"><span class="font-black text-xl">Menu</span><button onclick="toggleSidebar()"><i class="fa-solid fa-xmark"></i></button></div>
        <nav class="flex-1 px-4 space-y-1 overflow-y-auto py-4">
            <div onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</div>
            <div onclick="switchTab('reports')" class="nav-item" id="nav-reports">
    <i class="fa-solid fa-chart-line w-5"></i> Reports
</div>
<div onclick="switchTab('customers')" class="nav-item" id="nav-customers">
    <i class="fa-solid fa-users w-5"></i> Customers & CRM
</div>

            <div onclick="switchTab('orders')" class="nav-item" id="nav-orders"><i class="fa-solid fa-fire-burner w-5"></i> Live Orders</div>
            <div onclick="switchTab('notifications')" class="nav-item" id="nav-notifications"><i class="fa-solid fa-bell w-5"></i> Notifications</div>
            <div onclick="switchTab('website')" class="nav-item" id="nav-website"><i class="fa-solid fa-globe w-5"></i> Website</div>
            <div onclick="switchTab('history')" class="nav-item" id="nav-history"><i class="fa-solid fa-clock-rotate-left w-5"></i> History</div>
            <div onclick="switchTab('menu')" class="nav-item" id="nav-menu"><i class="fa-solid fa-burger w-5"></i> Menu & Sorting</div>
            <div onclick="switchTab('promo')" class="nav-item" id="nav-promo"><i class="fa-solid fa-ticket w-5"></i> Promo Codes</div>
            <div onclick="switchTab('content')" class="nav-item" id="nav-content"><i class="fa-solid fa-images w-5"></i> App Content</div>
            <div onclick="switchTab('info')" class="nav-item" id="nav-info"><i class="fa-solid fa-store w-5"></i> Info & Hours</div>
            <div onclick="switchTab('trans')" class="nav-item" id="nav-trans">
    <i class="fa-solid fa-language w-5"></i> Arabic Translations
</div>
<div onclick="switchTab('printer')" class="nav-item" id="nav-printer">
    <i class="fa-solid fa-print w-5"></i> Printer Settings
</div>


        </nav>
        <div class="p-6 border-t border-slate-50">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 p-3 font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-xl transition text-sm">Log Out</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative pt-20 md:pt-8 px-4 md:px-10 pb-10 scroll-smooth h-full">
        <header class="md:hidden fixed top-0 left-0 w-full bg-white/90 backdrop-blur-md border-b border-slate-100 z-40 px-5 py-3 flex justify-between items-center pt-safe h-16">
            <div class="flex items-center gap-3"><button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center text-slate-600"><i class="fa-solid fa-bars text-lg"></i></button><h1 class="text-xl font-black">TARI<span class="text-orange-500">.</span></h1></div>
            <div class="flex items-center gap-3">
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="store-toggle-m" class="sr-only peer" onchange="toggleStore(this.checked)">
                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                </label>
                <div class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="mobile-live-count">0</span></div>
            </div>
        </header>

        <div id="tab-dashboard" class="tab-content max-w-7xl mx-auto h-full animate-[fadeIn_0.2s]">
            <h2 class="text-2xl font-bold mb-6">Today's Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Orders Today</p><h3 class="text-4xl font-black text-slate-800 mt-2" id="dash-orders">0</h3></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Revenue</p><h3 class="text-4xl font-black text-orange-500 mt-2" id="dash-revenue">SR 0</h3></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-sm font-bold uppercase">Top Item</p><h3 class="text-2xl font-bold text-slate-800 mt-2 truncate" id="dash-top-item">--</h3></div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6"><h3 class="font-bold mb-4">Recent Activity</h3><div id="dash-activity" class="space-y-4 text-sm text-slate-500">Loading activity...</div></div>
        </div>
        <div id="tab-reports" class="tab-content hidden max-w-6xl mx-auto animate-[fadeIn_0.2s]">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h2 class="text-2xl font-bold">Sales Reports</h2>
            <p class="text-sm text-slate-400">Shift: 5:00 PM - 3:30 AM</p>
        </div>
        
        <div class="flex gap-2 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
            <select id="report-type" class="bg-transparent font-bold text-sm outline-none px-2" onchange="toggleReportInputs()">
                <option value="daily">Daily Shift</option>
                <option value="monthly">Monthly</option>
            </select>
            <div class="w-[1px] bg-slate-200"></div>
            <input type="date" id="report-date" class="bg-transparent font-bold text-sm outline-none text-slate-600">
            <input type="month" id="report-month" class="hidden bg-transparent font-bold text-sm outline-none text-slate-600">
            
            <button onclick="generateReport()" class="bg-slate-900 text-white px-4 py-1 rounded-lg text-xs font-bold hover:bg-slate-800 transition">Go</button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Total Revenue</p>
            <h3 class="text-3xl font-black text-slate-800 mt-1" id="rep-total">SR 0</h3>
        </div>
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Cash</p>
            <h3 class="text-2xl font-bold text-green-600 mt-1" id="rep-cash">SR 0</h3>
        </div>
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Card</p>
            <h3 class="text-2xl font-bold text-blue-500 mt-1" id="rep-card">SR 0</h3>
        </div>
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-[10px] font-bold text-slate-400 uppercase">Orders</p>
            <h3 class="text-2xl font-bold text-orange-500 mt-1" id="rep-count">0</h3>
        </div>
    </div>

    <div class="flex justify-between items-center mb-4">
        <div class="flex gap-2">
            <button onclick="filterReportCat('all')" class="px-3 py-1 bg-slate-200 rounded-lg text-xs font-bold text-slate-600 active-cat" id="cat-btn-all">All</button>
            <div id="report-cat-buttons" class="flex gap-2"></div>
        </div>
        <button onclick="exportReportHtml()" class="text-orange-500 font-bold text-sm hover:underline"><i class="fa-solid fa-file-export"></i> Export HTML</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-4 border-b border-slate-50 font-bold">Item Breakdown</div>
            <div class="max-h-[400px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold sticky top-0">
                        <tr>
                            <th class="p-3">Item</th>
                            <th class="p-3 text-center">Qty</th>
                            <th class="p-3 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="rep-items-list" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-4 border-b border-slate-50 font-bold">Shift Orders Log</div>
            <div class="max-h-[400px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold sticky top-0">
                        <tr>
                            <th class="p-3">Shift #</th>
                            <th class="p-3">Time</th>
                            <th class="p-3 text-right">Value</th>
                        </tr>
                    </thead>
                    <tbody id="rep-orders-list" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


        <div id="tab-notifications" class="tab-content hidden max-w-4xl mx-auto animate-[fadeIn_0.2s]">

            <h2 class="text-2xl font-bold mb-6">Notification Center</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-volume-high text-orange-500"></i> Alert Sound</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Select Sound</label>
                            <select id="sound-select" class="input-box mt-1" onchange="saveSoundSettings()">
                                <option value="bell">üõéÔ∏è Service Bell</option>
                                <option value="chime">‚ú® Magic Chime</option>
                                <option value="tech">ü§ñ Tech Alert</option>
                                <option value="custom">üìÇ Custom Upload</option>
                            </select>
                        </div>
                        
                        <div id="custom-sound-upload" class="hidden">
                            <label class="block w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-center cursor-pointer hover:bg-slate-50 transition">
                                <span class="text-xs font-bold text-slate-500"><i class="fa-solid fa-upload mr-1"></i> Upload MP3/WAV</span>
                                <input type="file" id="sound-file-input" class="hidden" accept="audio/*" onchange="uploadCustomSound(this)">
                            </label>
                            <p id="custom-file-name" class="text-xs text-green-500 font-bold mt-2 text-center"></p>
                        </div>

                        <button onclick="playNotification()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition"><i class="fa-solid fa-play mr-2"></i> Test Sound</button>
                    </div>
                </div>

                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-bell text-orange-500"></i> Popups & Mobile</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sm text-slate-700">Browser Permission</p>
                                <p id="perm-status" class="text-xs text-slate-400 font-bold">Checking...</p>
                            </div>
                            <div id="perm-indicator" class="w-3 h-3 rounded-full bg-slate-300"></div>
                        </div>
                        
                        <p class="text-xs text-slate-400 leading-relaxed">
                            <strong>Note for Android:</strong> You must click "Enable Notifications" below. If sound doesn't play automatically, click anywhere on the screen once to unlock audio permissions.
                        </p>

                        <button onclick="requestNotificationPermission()" class="w-full py-3 bg-orange-50 text-orange-600 border border-orange-200 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition hover:bg-orange-100">Enable Notifications</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-printer" class="tab-content hidden max-w-4xl mx-auto animate-[fadeIn_0.2s]">
    <h2 class="text-2xl font-bold mb-6">Printer Configuration</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="glass-card p-6 h-fit">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i class="fa-solid fa-star text-orange-500"></i> Receipt Branding
            </h3>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase block mb-2">Printer Logo (Black & White)</label>
                
                <div class="img-uploader h-32 bg-slate-50 border-2 border-dashed border-slate-200" onclick="document.getElementById('printer-logo-input').click()">
                    <img id="printer-logo-preview" class="absolute inset-0 w-full h-full object-contain p-4 hidden">
                    
                    <div class="text-center" id="printer-logo-placeholder">
                        <i class="fa-solid fa-file-image text-2xl text-slate-300 mb-1"></i>
                        <span class="block text-xs font-bold text-slate-400">Tap to Upload</span>
                    </div>
                    
                    <input type="file" id="printer-logo-input" class="hidden" accept="image/*" onchange="startCrop(this, 'printer-logo')">
                </div>

                <button id="btn-rm-printer-logo" onclick="removePrinterLogo()" class="hidden w-full py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg mt-2 transition">
                    <i class="fa-solid fa-trash mr-1"></i> Remove Logo
                </button>
            </div>
            
            <button onclick="savePrinterSettings(this)" class="btn-main w-full bg-slate-900 shadow-lg text-sm">
                Save Branding
            </button>
        </div>

        <div class="glass-card p-6 h-fit">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i class="fa-solid fa-power-off text-orange-500"></i> Auto-Print Logic
            </h3>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center mb-6">
                <div>
                    <p class="font-bold text-sm text-slate-700">Auto Accept & Print</p>
                    <p class="text-xs text-slate-400 mt-1">Automatic "Preparing" status</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="auto-print-toggle" class="sr-only peer" onchange="toggleAutoPrint(this.checked)">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-900"></div>
                </label>
            </div>

             <div class="border-t border-slate-100 pt-4">
                <h4 class="font-bold text-sm mb-2">Connection Test</h4>
                <button onclick="printLatestOrder()" class="w-full py-3 bg-white border-2 border-slate-100 text-slate-600 rounded-xl font-bold text-sm shadow-sm hover:border-orange-200 hover:text-orange-500 hover:bg-orange-50 transition active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print"></i> Send Test Receipt
                </button>
            </div>
        </div>

    </div>
</div>

<div id="tab-trans" class="tab-content hidden max-w-4xl mx-auto animate-[fadeIn_0.2s]">
    <div class="pro-header">
        <div>
            <h2 class="pro-title">Arabic Translation Manager</h2>
            <p class="pro-subtitle">Translate your menu and categories for the Arabic app.</p>
        </div>
        <button onclick="saveTranslations(this)" class="btn-main bg-slate-900 shadow-lg">
            <i class="fa-solid fa-floppy-disk"></i> Save Translations
        </button>
    </div>

    <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex items-start gap-3 mb-6">
        <i class="fa-solid fa-circle-info text-orange-500 mt-0.5"></i>
        <div class="text-sm text-slate-600">
            <strong>How this works:</strong> The English name from your menu is the "Key". Type the Arabic equivalent in the box. 
            The customer app will automatically look up the Arabic name using the English Key.
        </div>
    </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-xs"><i class="fa-solid fa-layer-group"></i></span>
        Categories
    </h3>
    <div id="trans-cat-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center text-xs"><i class="fa-solid fa-burger"></i></span>
        Menu Items
    </h3>
    <div id="trans-item-list" class="space-y-3">
        </div>
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 mt-8">
        <span class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center text-xs"><i class="fa-solid fa-star"></i></span>
        Splash Screen
    </h3>
    <div id="trans-splash-list" class="grid grid-cols-1 gap-4 mb-8">
        </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-green-100 text-green-600 flex items-center justify-center text-xs"><i class="fa-solid fa-list-check"></i></span>
        Modifiers & Options
    </h3>
    <div id="trans-mod-list" class="space-y-4">
        
        </div>

    <h3 class="font-bold text-lg mb-4 flex items-center gap-2 mt-8">
        <span class="w-8 h-8 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center text-xs"><i class="fa-solid fa-map-pin"></i></span>
        Business Info
    </h3>
    <div id="trans-info-container" class="grid grid-cols-1 gap-4 mb-8">
        </div>
</div> 


        <div id="tab-website" class="tab-content hidden max-w-4xl mx-auto h-full animate-[fadeIn_0.2s]">
            <h2 class="text-2xl font-bold mb-6">Website Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4">Branding & Logo</h3>
                    <div class="space-y-4">
                        <div class="img-uploader h-32 bg-slate-50" onclick="document.getElementById('web-logo-input').click()">
                            <img id="web-logo-preview" class="absolute inset-0 w-full h-full object-contain p-2 hidden">
                            <div class="text-center">
                                <i class="fa-solid fa-image text-2xl text-slate-300 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-400">Upload Truck Logo</span>
                            </div>
                            <input type="file" id="web-logo-input" class="hidden" accept="image/*" onchange="startCrop(this, 'web-logo')">
                        </div>
                        <p class="text-[10px] text-slate-400">This logo will appear at the top-left of the customer page.</p>
                    </div>
                </div>

                <div class="glass-card p-6 h-fit">
                    <h3 class="font-bold text-lg mb-4">Colors & Background</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Header Color</label>
                            <div class="flex items-center gap-3 mt-1">
                                <input type="color" id="web-header-color" class="w-12 h-10 rounded-lg cursor-pointer border border-slate-200" value="#ffffff">
                                <span class="text-sm font-bold text-slate-600">Top Bar Background</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Page Background Color</label>
                            <div class="flex items-center gap-3 mt-1">
                                <input type="color" id="web-bg-color" class="w-12 h-10 rounded-lg cursor-pointer border border-slate-200" value="#F8FAFC">
                                <span class="text-sm font-bold text-slate-600">Main Background</span>
                            </div>
                        </div>
                        
                        <div>
    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Background Image (Optional)</label>
    <div class="img-uploader h-20" onclick="document.getElementById('web-bg-img-input').click()">
        <img id="web-bg-img-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg opacity-50">
        <span class="text-xs font-bold text-slate-400">Upload Background</span>
        <input type="file" id="web-bg-img-input" class="hidden" accept="image/*" onchange="startCrop(this, 'web-bg')">
    </div>
    <button id="btn-remove-bg" onclick="removeWebBg()" class="hidden w-full py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg mt-1 transition"><i class="fa-solid fa-trash"></i> Remove Image</button>
</div>
            <button onclick="saveWebsiteSettings(this)" class="btn-main w-full mt-6 bg-slate-900 text-white shadow-lg">Save Website Changes</button>
          </div>
        </div>
     </div>
  </div>
 <div id="tab-customers" class="tab-content hidden max-w-7xl mx-auto animate-[fadeIn_0.2s]">
    
    <div class="pro-header">
        <div>
            <h2 class="pro-title">Customer Base</h2>
            <p class="pro-subtitle">Manage users, track spending, and send marketing.</p>
        </div>
        <div class="flex gap-3">
             <button onclick="openMsgHistory()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                <i class="fa-solid fa-clock-rotate-left mr-2"></i> History
            </button>
            <button id="btn-send-offer" onclick="openOfferModal()" class="hidden px-6 py-2 bg-green-500 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-green-600 transition animate-bounce">
                <i class="fa-brands fa-whatsapp text-lg mr-2"></i> Send Offer (<span id="sel-count">0</span>)
            </button>
        </div>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mb-6 justify-between items-center">
        <div class="relative w-full md:w-1/3">
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
            <input id="cust-search" onkeyup="filterCustomers()" class="input-box pl-10" placeholder="Search name or phone...">
        </div>
        
        <div class="flex gap-2">
            <select id="cust-sort" onchange="renderCustomerTable()" class="input-box w-auto font-bold text-slate-600">
                <option value="newest">üìÖ Newest Joined</option>
                <option value="spend">üí∞ Highest Spender</option>
                <option value="orders">üî• Most Orders</option>
                <option value="name">abc Name (A-Z)</option>
            </select>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
        <table class="w-full text-left text-sm min-w-[800px]">
            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-400 font-bold">
                <tr>
                    <th class="p-4 w-10">
                        <input type="checkbox" id="select-all-cust" onchange="toggleSelectAll(this)" class="accent-green-500 w-4 h-4 cursor-pointer">
                    </th>
                    <th class="p-4">Customer</th>
                    <th class="p-4">Phone</th>
                    <th class="p-4 text-center">Orders</th>
                    <th class="p-4 text-right">Total Spent</th>
                    <th class="p-4 text-center">Status</th>
                    <th class="p-4 text-center">Action</th>
                </tr>
            </thead>
            <tbody id="cust-list" class="divide-y divide-slate-50">
                </tbody>
        </table>
    </div>
</div>

<div id="offerModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-3xl p-0 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-[#25D366] p-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-3">
                <i class="fa-brands fa-whatsapp text-3xl"></i>
                <div>
                    <h3 class="font-black text-lg">New Campaign</h3>
                    <p class="text-xs opacity-90 font-bold">Via WaSenderAPI</p>
                </div>
            </div>
            <button onclick="closeModal('offerModal')" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 space-y-5">
            
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Recipients</label>
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 min-h-[50px] flex flex-wrap gap-2" id="recipient-chips"></div>
                <div class="flex gap-2 mt-2">
                    <input id="manual-phone" class="input-box py-2 text-sm" placeholder="Add manual number (e.g. 9665...)">
                    <button onclick="addManualRecipient()" class="bg-slate-200 text-slate-600 px-4 rounded-xl font-bold text-xs hover:bg-slate-300">+ Add</button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Message Text</label>
                <textarea id="wa-msg" class="input-box h-32 resize-none leading-relaxed" placeholder="Hello! Check out our new burger..."></textarea>
                <div class="flex gap-2 mt-2 overflow-x-auto pb-1" id="quick-tags">
                    <button onclick="insertTag('{name}')" class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-[10px] font-bold border border-blue-100 hover:bg-blue-100">{name}</button>
                    <button onclick="insertTag('{coupon}')" class="px-2 py-1 bg-purple-50 text-purple-600 rounded text-[10px] font-bold border border-purple-100 hover:bg-purple-100">{coupon}</button>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Image (Optional)</label>
                <div class="img-uploader h-24" onclick="document.getElementById('wa-img-input').click()">
                    <img id="wa-img-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg">
                    <span class="text-xs font-bold text-slate-400"><i class="fa-solid fa-image mr-1"></i> Upload Banner</span>
                    <input type="file" id="wa-img-input" class="hidden" accept="image/*" onchange="previewWaImg(this)">
                </div>
                <button id="btn-rm-wa-img" onclick="removeWaImg()" class="hidden text-xs text-red-500 font-bold mt-2">Remove Image</button>
            </div>

        </div>

        <div class="p-4 border-t bg-slate-50 flex justify-end gap-3">
            <button onclick="closeModal('offerModal')" class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200">Cancel</button>
            <button onclick="sendCampaign()" id="btn-send-wa" class="px-8 py-3 rounded-xl font-bold text-white bg-[#25D366] shadow-lg hover:brightness-105 flex items-center gap-2">
                <i class="fa-regular fa-paper-plane"></i> Send Now
            </button>
        </div>
    </div>
</div>

<div id="historyMsgModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-xl">Campaign History</h3>
            <button onclick="closeModal('historyMsgModal')"><i class="fa-solid fa-xmark text-xl text-slate-400"></i></button>
        </div>
        <div id="msg-history-list" class="flex-1 overflow-y-auto space-y-3">
            </div>
    </div>
</div>

        <div id="tab-orders" class="tab-content hidden max-w-7xl mx-auto h-full flex flex-col animate-[fadeIn_0.2s]">
            <div class="flex justify-between items-center mb-6"><div><h2 class="text-2xl font-bold">Kitchen Board</h2><p class="text-sm text-slate-400">Live order management</p></div><div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 font-bold text-sm flex items-center gap-2 hidden md:flex"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> <span id="live-count">0</span> Active</div></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 overflow-y-auto pb-safe">
                <div class="bg-slate-100/50 rounded-2xl p-4 border border-slate-200 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-slate-500 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-blue-500 text-[8px]"></i> Incoming</h3><div id="col-new" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
                <div class="bg-orange-50/50 rounded-2xl p-4 border border-orange-100 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-orange-600 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-orange-500 text-[8px]"></i> Cooking</h3><div id="col-cooking" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
                <div class="bg-green-50/50 rounded-2xl p-4 border border-green-100 flex flex-col h-fit md:h-auto"><h3 class="font-bold text-green-600 text-xs uppercase mb-4 flex items-center gap-2 sticky top-0"><i class="fa-solid fa-circle text-green-500 text-[8px]"></i> Ready</h3><div id="col-ready" class="space-y-3 flex-1 overflow-y-auto min-h-[100px]"></div></div>
            </div>
        </div>

        <div id="tab-history" class="tab-content hidden max-w-5xl mx-auto">
    <h2 class="text-2xl font-bold mb-6">Order History</h2>
    
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden overflow-x-auto">
        
        <table class="w-full text-left text-sm min-w-[700px]">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                    <th class="p-4 font-bold whitespace-nowrap">ID</th>
                    <th class="p-4 font-bold whitespace-nowrap">Date</th>
                    <th class="p-4 font-bold whitespace-nowrap">Items</th>
                    <th class="p-4 font-bold whitespace-nowrap">Total</th>
                    <th class="p-4 font-bold whitespace-nowrap">Action</th>
                </tr>
            </thead>
            <tbody id="history-list" class="divide-y divide-slate-100"></tbody>
        </table>
        
    </div>
</div>

        
        <div id="tab-menu" class="tab-content hidden max-w-5xl mx-auto">
    
    <div class="pro-header">
        <div>
            <h2 class="pro-title">Menu Manager</h2>
            <p class="pro-subtitle">Manage your food, categories, and options.</p>
        </div>
        <button onclick="saveMenuOrder(this)" id="save-order-btn" class="hidden bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg hover:bg-slate-800 transition transform active:scale-95">
            Save New Order
        </button>
    </div>

    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl mb-8 w-fit">
        <button onclick="switchMenuSub('items')" id="sub-items" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all shadow-sm bg-white text-slate-900">Items</button>
        <button onclick="switchMenuSub('cats')" id="sub-cats" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900">Categories</button>
        <button onclick="switchMenuSub('mods')" id="sub-mods" class="px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900">Modifiers</button>
    </div>

    <div id="view-items">
        <button onclick="openMenuModal()" class="w-full py-6 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold hover:bg-white hover:border-orange-400 hover:text-orange-500 transition mb-6 flex items-center justify-center gap-2 group">
            <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-orange-100 flex items-center justify-center transition"><i class="fa-solid fa-plus"></i></div> 
            Add New Menu Item
        </button>
        <div id="menu-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="view-cats" class="hidden">
        <div class="glass-card p-6 mb-6">
            <h3 class="font-bold text-lg mb-4">Add Category</h3>
            <div class="flex gap-3">
                <input id="new-cat-name" class="input-box" placeholder="Category Name (e.g. Burgers)">
                <button onclick="addCategory()" class="bg-slate-900 text-white px-6 rounded-xl font-bold text-sm hover:bg-slate-800 transition">Add</button>
            </div>
        </div>
        <div id="cats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="view-mods" class="hidden">
        <button onclick="openModModal()" class="w-full py-6 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold hover:bg-white hover:border-orange-400 hover:text-orange-500 transition mb-6 flex items-center justify-center gap-2 group">
             <div class="w-8 h-8 rounded-full bg-slate-100 group-hover:bg-orange-100 flex items-center justify-center transition"><i class="fa-solid fa-layer-group"></i></div>
             Create Modifier Group
        </button>
        <div id="modifiers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

        
        <div id="tab-promo" class="tab-content hidden max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">Promotions</h2>

            <div class="glass-card p-6 mb-8 bg-gradient-to-br from-orange-50 to-white border-orange-100">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-500 text-xl">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">New Customer Discount</h3>
                        <p class="text-sm text-slate-500">Applied to first order.</p>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <div class="flex gap-3">
                        <input id="new-user-code" type="text" class="input-box font-bold uppercase text-orange-600" placeholder="Code Name (e.g. WELCOME30)">
                    </div>
                    <div class="flex gap-3">
                        <select id="new-user-type" class="input-box w-1/3">
                            <option value="percent">% Off</option>
                            <option value="fixed">SR Off</option>
                        </select>
                        <input id="new-user-val" type="number" class="input-box w-1/3" placeholder="Value">
                        <button onclick="saveNewUserPromo(this)" class="btn-main w-1/3 bg-orange-500">Save</button>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6 mb-8 bg-gradient-to-br from-purple-50 to-white border-purple-100">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-500 text-xl">
                        <i class="fa-solid fa-crown"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">Loyalty Rewards</h3>
                        <p class="text-sm text-slate-500">How do customers earn points?</p>
                    </div>
                </div>

                <div class="flex gap-4 items-end">
                    <div class="w-1/2">
                        <label class="text-xs font-bold text-slate-400 uppercase">Reward Type</label>
                        <select id="loyalty-type" class="input-box mt-1 bg-white">
                            <option value="fixed">Fixed (Points per Order)</option>
                            <option value="percentage">Percentage (1 Pt per 1 SR)</option>
                        </select>
                    </div>
                    <div class="w-1/4">
                        <label class="text-xs font-bold text-slate-400 uppercase">Value</label>
                        <input id="loyalty-val" type="number" class="input-box mt-1" placeholder="10">
                    </div>
                    <button onclick="saveLoyaltySettings(this)" class="btn-main w-1/4 bg-purple-600 shadow-lg text-sm">Update</button>
                </div>
                <p class="text-[10px] text-slate-400 mt-2 italic">
                    * "Percentage" means if they spend 50 SR, and value is 10%, they get 5 points.
                </p>
            </div>

            <div class="flex w-full justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-800">Active Codes</h3>
                <button onclick="openPromoModal()" class="text-orange-500 font-bold text-sm hover:text-orange-600 transition px-3 py-2 rounded-lg hover:bg-orange-50">
                    + Add Code
                </button>
            </div>
            <div id="promo-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div> 
        <div id="tab-content" class="tab-content hidden max-w-5xl mx-auto"><h2 class="text-2xl font-bold mb-6">Content</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass-card p-6"><h3 class="font-bold mb-4">Splash</h3><div class="space-y-3"><input id="splash-title" class="input-box" placeholder="Title"><textarea id="splash-intro" class="input-box h-20" placeholder="Text..."></textarea><div class="grid grid-cols-2 gap-3"><div class="img-uploader h-24" onclick="document.getElementById('splash-bg-input').click()"><img id="splash-bg-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg"><span class="text-xs font-bold text-slate-400">Background</span><input type="file" id="splash-bg-input" class="hidden" accept="image/*" onchange="startCrop(this, 'splash-bg')"></div><div class="img-uploader h-24" onclick="document.getElementById('splash-c-input').click()"><img id="splash-c-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-lg"><span class="text-xs font-bold text-slate-400">Center Circle</span><input type="file" id="splash-c-input" class="hidden" accept="image/*" onchange="startCrop(this, 'splash-c')"></div></div><button onclick="saveSplashSettings(this)" class="btn-main w-full text-sm mt-2">Update Splash</button></div></div><div class="glass-card p-6"><h3 class="font-bold mb-4">Hero Slider</h3><div class="grid grid-cols-3 gap-2 mb-4" id="hero-list-container"></div><button onclick="document.getElementById('hero-input').click()" class="w-full py-2 border border-dashed rounded-xl text-slate-400 font-bold mb-4 text-sm">+ Add Image</button><input type="file" id="hero-input" class="hidden" accept="image/*" onchange="startCrop(this, 'hero')"><button onclick="saveHeroSettings(this)" class="btn-main w-full text-sm">Save Slider</button></div></div><div class="glass-card p-6 mt-6">
    <h3 class="font-bold mb-4">App Design</h3>
    <div class="grid grid-cols-2 gap-6 mb-4">
        <div>
            <label class="font-bold text-sm block mb-2">Primary Brand Color</label>
            <div class="flex items-center gap-3">
                <input type="color" id="design-color" class="w-full h-12 rounded-xl cursor-pointer border border-slate-200" value="#FF5722">
            </div>
        </div>
        <div>
            <label class="font-bold text-sm block mb-2">App Background</label>
            <div class="flex items-center gap-3">
                <input type="color" id="design-bg-color" class="w-full h-12 rounded-xl cursor-pointer border border-slate-200" value="#F8FAFC">
            </div>
        </div>
    </div>
    <button onclick="saveDesign(this)" class="btn-main w-full bg-slate-900 text-white shadow-lg">Update App Theme</button>
</div>
</div>
        <div id="tab-info" class="tab-content hidden max-w-2xl mx-auto">
    <h2 class="text-2xl font-bold mb-6">Business Info</h2>
    
    <div class="glass-card p-6 mb-6 space-y-4">
        
        <div>
            <label class="text-xs font-bold text-slate-400 uppercase">Address Text (Visible)</label>
            <input id="info-loc" class="input-box mt-1" placeholder="e.g. Prince Sultan St, Jeddah">
        </div>

        <div>
            <label class="text-xs font-bold text-slate-400 uppercase">Google Maps Link (Clickable)</label>
            <div class="flex gap-2 mt-1">
                <input id="info-maps" class="input-box text-blue-600" placeholder="https://maps.app.goo.gl/...">
                <a id="btn-test-map" href="#" target="_blank" class="hidden w-12 bg-slate-100 text-slate-500 rounded-xl flex items-center justify-center hover:bg-orange-100 hover:text-orange-500 transition border border-slate-200">
                    <i class="fa-solid fa-location-arrow"></i>
                </a>
            </div>
            <p class="text-[10px] text-slate-400 mt-1">Paste the "Share" link from Google Maps here.</p>
        </div>

        <div class="w-full h-[1px] bg-slate-100 my-4"></div>

        <div>
            <label class="text-xs font-bold text-slate-400 uppercase">Phone</label>
            <input id="info-phone" class="input-box mt-1">
        </div>
        
        <div>
            <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">Working Hours</label>
            <div id="hours-container" class="space-y-2 mb-2"></div>
            <button onclick="addHourRow()" class="text-xs font-bold text-orange-500">+ Add Day</button>
        </div>

        <div class="pt-4">
            <label class="text-xs font-bold text-slate-400 uppercase">Social Links</label>
            <div class="space-y-3 mt-2">
                <input id="info-insta" type="text" class="input-box" placeholder="Instagram URL">
                <input id="info-twit" type="text" class="input-box" placeholder="Twitter URL">
                <input id="info-tik" type="text" class="input-box" placeholder="TikTok URL">
            </div>
        </div>

        <button onclick="saveInfo(this)" class="btn-main w-full mt-4 bg-slate-900 shadow-lg">Save Info</button>
    </div>
</div>

    </main>
<div id="paymentModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-[scaleIn_0.2s]">
        <div class="text-center mb-6">
            <h3 class="font-bold text-xl text-slate-800">Finalize Payment</h3>
            <p class="text-slate-400 text-sm">Order Total</p>
            <h2 class="text-4xl font-black text-slate-900 mt-1" id="pay-total-display">SR 0.00</h2>
        </div>

        <input type="hidden" id="pay-order-id">
        <input type="hidden" id="pay-total-val">

        <div class="space-y-4 mb-6">
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-sm text-slate-600"><i class="fa-solid fa-money-bill-wave text-green-500 mr-2"></i>Cash</label>
                    <span class="text-xs font-bold text-slate-400 cursor-pointer hover:text-orange-500" onclick="fillMax('cash')">Max</span>
                </div>
                <input type="number" id="pay-cash" class="w-full bg-transparent font-bold text-xl outline-none placeholder-slate-300" placeholder="0.00" oninput="autoCalc('cash')">
            </div>

            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-sm text-slate-600"><i class="fa-solid fa-credit-card text-blue-500 mr-2"></i>Card</label>
                    <span class="text-xs font-bold text-slate-400 cursor-pointer hover:text-orange-500" onclick="fillMax('card')">Max</span>
                </div>
                <input type="number" id="pay-card" class="w-full bg-transparent font-bold text-xl outline-none placeholder-slate-300" placeholder="0.00" oninput="autoCalc('card')">
            </div>
        </div>

        <div class="flex justify-between items-center mb-6 px-2">
            <span class="text-xs font-bold text-slate-400 uppercase">Remaining</span>
            <span id="pay-remaining" class="font-bold text-red-500">SR 0.00</span>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeModal('paymentModal')" class="btn-main bg-slate-100 text-slate-500 hover:bg-slate-200">Cancel</button>
            <button onclick="confirmPayment(this)" id="btn-finish-pay" class="btn-main bg-green-600 shadow-lg text-white" disabled>Confirm</button>
        </div>
    </div>
</div>

    <div id="timeModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    
    <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center animate-[scaleIn_0.2s]">
        <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚è±Ô∏è</div>
        <h3 class="font-bold text-xl mb-2">Order Time?</h3>
        
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="selectTime(10, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">10m</button>
            <button onclick="selectTime(15, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">15m</button>
            <button onclick="selectTime(20, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">20m</button>
            <button onclick="selectTime(25, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">25m</button>
            <button onclick="selectTime(30, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">30m</button>
            <button onclick="selectTime(45, this)" class="time-btn py-3 bg-slate-50 border border-slate-200 rounded-xl font-bold hover:bg-orange-50 hover:border-orange-500 transition">45m</button>
        </div>

        <input id="custom-time" type="number" placeholder="Or type minutes..." class="input-box text-center font-bold text-lg mb-6" oninput="clearTimeSelection()">

        <button onclick="confirmTime()" class="btn-main w-full bg-orange-600 shadow-lg py-4 text-lg">Start Order</button>
    </div>
</div>

    <div id="menuModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-end md:items-center justify-center p-0 md:p-4">
    
    <div class="bg-white w-full md:max-w-lg md:rounded-3xl rounded-t-3xl h-[85vh] flex flex-col shadow-2xl overflow-hidden animate-[slideUp_0.3s]">
        
        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-white z-10">
            <h3 class="font-black text-xl text-slate-800" id="menu-modal-title">Add New Item</h3>
            <button onclick="closeModal('menuModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-slate-800 flex items-center justify-center transition">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-5">
            <input type="hidden" id="menu-id">
            
            <div class="relative group">
                <div class="img-uploader h-48 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-orange-50 hover:border-orange-200 transition" onclick="document.getElementById('menu-file').click()">
                    
                    <img id="m-img-preview" class="absolute inset-0 w-full h-full object-cover hidden rounded-2xl z-10">
                    
                    <div class="text-center">
                        <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 text-slate-300">
                            <i class="fa-solid fa-camera text-xl"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Tap to Upload Image</span>
                    </div>
                    
                    <input type="file" id="menu-file" class="hidden" accept="image/*" onchange="startCrop(this, 'menu')">
                </div>

                <button id="btn-rm-menu-img" onclick="removeMenuImage(event)" class="btn-remove-img hidden">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <div class="space-y-4">
    <input id="m-name" class="input-box text-lg font-bold" placeholder="Item Name">
    
    <div class="grid grid-cols-2 gap-4">
        <input id="m-price" type="number" class="input-box" placeholder="Price (SR)">
        <select id="m-cat" class="input-box text-slate-700">
            <option value="" disabled selected>Category</option>
            </select>
    </div>

    <div>
        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Loyverse Variant ID (Optional)</label>
        <div class="relative">
             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-fingerprint text-slate-300"></i>
            </div>
            <input id="m-loyverse-id" class="input-box pl-9 text-xs font-mono text-blue-600 bg-slate-50 border-slate-200 focus:bg-white transition" placeholder="Paste UUID here (e.g. 909438ba...)">
        </div>
    </div>
    
    <textarea id="m-desc" class="input-box h-24 resize-none leading-relaxed" placeholder="Description..."></textarea>
</div>


            <div class="flex gap-4">
                <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-2xl flex-1 justify-center cursor-pointer bg-white hover:border-slate-300 transition">
                    <input type="checkbox" id="m-available" class="accent-slate-900 w-5 h-5" checked> 
                    <span class="font-bold text-sm text-slate-700">Available</span>
                </label>
                <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-2xl flex-1 justify-center cursor-pointer bg-white hover:border-slate-300 transition">
                    <input type="checkbox" id="m-best" class="accent-orange-500 w-5 h-5"> 
                    <span class="font-bold text-sm text-slate-700">Best Seller</span>
                </label>
            </div>

            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                <h4 class="font-bold text-xs text-slate-400 uppercase tracking-widest mb-3">Modifiers</h4>
                <div id="item-modifier-list" class="space-y-2"></div>
            </div>
        </div>

        <div class="p-6 border-t border-slate-50 bg-white z-10">
            <button onclick="saveMenuItem(this)" class="btn-main w-full bg-slate-900 text-white shadow-xl py-4 text-lg rounded-2xl hover:scale-[1.01]">Save Item</button>
        </div>
    </div>
</div>

    <div id="modModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4" id="mod-modal-title">Edit Modifier Group</h3><input type="hidden" id="mod-id"><input id="mod-group-name" class="input-box mb-4" placeholder="Group Name (e.g. Sauces)"><div id="mod-options-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div><button onclick="addModOptionInput()" class="text-xs font-bold text-orange-500 mb-4">+ Add Option</button><div class="flex items-center gap-2 mb-4"><input type="checkbox" id="mod-required" class="accent-orange-500"><label for="mod-required" class="text-sm">Required?</label></div><div class="grid grid-cols-2 gap-3"><button onclick="closeModal('modModal')" class="btn-main bg-slate-100 text-slate-500">Cancel</button><button onclick="saveModGroup(this)" class="btn-main bg-slate-900">Save</button></div></div></div>
    <div id="promoModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4">Add Promo</h3><input id="p-code" class="input-box mb-3 uppercase font-black tracking-widest text-center" placeholder="CODE"><div class="grid grid-cols-2 gap-3 mb-3"><select id="p-type" class="input-box"><option value="percent">% Off</option><option value="fixed">SR Off</option></select><input id="p-val" type="number" class="input-box" placeholder="Val"></div><input type="datetime-local" id="p-exp" class="input-box mb-4"><div class="grid grid-cols-2 gap-3"><button onclick="closeModal('promoModal')" class="btn-main bg-slate-100 text-slate-500">Cancel</button><button onclick="savePromo(this)" class="btn-main">Create</button></div></div></div>
    <div id="confirmModal" class="fixed inset-0 z-[200] bg-slate-900/30 backdrop-blur-[2px] hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-[90%] max-w-sm transform scale-95 transition-all duration-200" id="confirmBox">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6 mx-auto text-2xl animate-bounce">
             <i class="fa-solid fa-trash-can"></i>
        </div>
        <h3 class="text-xl font-black text-slate-800 mb-2 text-center">Are you sure?</h3>
        <p id="confirmMsg" class="text-sm text-slate-500 mb-8 text-center leading-relaxed">This action cannot be undone.</p>
        <div class="flex gap-3">
            <button onclick="resolveConfirm(false)" class="flex-1 py-3.5 rounded-2xl font-bold text-slate-500 bg-slate-50 hover:bg-slate-100 transition text-sm">Cancel</button>
            <button onclick="resolveConfirm(true)" class="flex-1 py-3.5 rounded-2xl font-bold bg-red-500 text-white shadow-lg shadow-red-500/30 hover:scale-[1.02] active:scale-95 transition text-sm">Yes, Delete</button>
        </div>
    </div>
</div>

<div id="historyModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-3xl p-0 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
            <h3 class="font-bold text-lg">Order Details</h3>
            <button onclick="closeModal('historyModal')"><i class="fa-solid fa-xmark text-xl text-slate-400"></i></button>
        </div>
        <div id="history-modal-content" class="p-6 overflow-y-auto flex-1">
            </div>
        <div class="p-4 border-t bg-white flex gap-3">
    <button onclick="printOrderReceipt(currentHistoryId, 'en')" class="flex-1 bg-slate-100 text-slate-900 py-3 rounded-xl font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2">
        <span class="font-black">EN</span> Receipt
    </button>
    
    <button onclick="printOrderReceipt(currentHistoryId, 'ar')" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
        <span class="font-black">AR</span> ŸÅÿßÿ™Ÿàÿ±ÿ©
    </button>
</div>



    <script>
        window.addEventListener('error', () => {
  document.getElementById('preloader')?.classList.add('loaded');
  document.getElementById('auth-overlay')?.classList.remove('hidden');
});

window.addEventListener('unhandledrejection', () => {
  document.getElementById('preloader')?.classList.add('loaded');
  document.getElementById('auth-overlay')?.classList.remove('hidden');
});
        const SUPABASE_URL = "https://fpgspmhgwcmhaaxsphcd.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwZ3NwbWhnd2NtaGFheHNwaGNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjYyMTEsImV4cCI6MjA4MTQwMjIxMX0.QyChZ3agLF1MiTzB8XzbrP4pCgBXsT1i9VWfQqu_VOw";
        
        // --- SMART PAYMENT LOGIC ---

// 1. Intercept the "Complete" action
window.updateStatus = async (id, status, totalAmount = 0) => {
    // If we are just moving to "Ready", do it normally
    if (status !== 'Completed') {
        await db.from('orders').update({ status }).eq('id', id);
        window.fetchOrders();
        return showToast("Order Updated");
    }

    // If "Completed", OPEN PAYMENT MODAL instead
    // We need to fetch the total first if not passed (simple lookup)
    if(totalAmount === 0) {
        const { data } = await db.from('orders').select('total').eq('id', id).single();
        totalAmount = data.total;
    }

    openPaymentModal(id, totalAmount);
};

// 2. Open Modal & Setup
window.openPaymentModal = (id, total) => {
    document.getElementById('pay-order-id').value = id;
    document.getElementById('pay-total-val').value = total;
    document.getElementById('pay-total-display').innerText = `SR ${total.toFixed(2)}`;
    
    // Reset Inputs
    document.getElementById('pay-cash').value = '';
    document.getElementById('pay-card').value = '';
    
    // Default: Assume full payment by Card (or your preferred default)
    document.getElementById('pay-card').value = total;
    
    validatePayment();
    document.getElementById('paymentModal').classList.remove('hidden');
};

// 3. Auto-Calculate Split
window.autoCalc = (changed) => {
    const total = parseFloat(document.getElementById('pay-total-val').value);
    const cashInput = document.getElementById('pay-cash');
    const cardInput = document.getElementById('pay-card');
    
    let cash = parseFloat(cashInput.value) || 0;
    let card = parseFloat(cardInput.value) || 0;

    // If user types in Cash, auto-fill Card with remainder
    if(changed === 'cash') {
        card = total - cash;
        cardInput.value = card < 0 ? 0 : card.toFixed(2); // No negative numbers
    }
    // If user types in Card, auto-fill Cash
    else if(changed === 'card') {
        cash = total - card;
        cashInput.value = cash < 0 ? 0 : cash.toFixed(2);
    }
    
    validatePayment();
};

window.fillMax = (type) => {
    const total = parseFloat(document.getElementById('pay-total-val').value);
    document.getElementById('pay-cash').value = type === 'cash' ? total : 0;
    document.getElementById('pay-card').value = type === 'card' ? total : 0;
    validatePayment();
}

window.validatePayment = () => {
    const total = parseFloat(document.getElementById('pay-total-val').value);
    const cash = parseFloat(document.getElementById('pay-cash').value) || 0;
    const card = parseFloat(document.getElementById('pay-card').value) || 0;
    
    const sum = cash + card;
    const remaining = total - sum;
    
    const remEl = document.getElementById('pay-remaining');
    const btn = document.getElementById('btn-finish-pay');

    // Allow a tiny margin of error for decimals (0.01)
    if (Math.abs(remaining) < 0.01) {
        remEl.innerText = "Paid Full";
        remEl.className = "font-bold text-green-500";
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        remEl.innerText = remaining > 0 ? `Remaining: ${remaining.toFixed(2)}` : `Overpaid: ${Math.abs(remaining).toFixed(2)}`;
        remEl.className = "font-bold text-red-500";
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    }
};

// 4. Save & Sync
window.confirmPayment = async (btn) => {
    setBtnLoading(btn, true);
    
    const id = document.getElementById('pay-order-id').value;
    const cash = parseFloat(document.getElementById('pay-cash').value) || 0;
    const card = parseFloat(document.getElementById('pay-card').value) || 0;
    
    const splitData = { cash: cash, card: card };

    // Update DB with 'Completed' status AND the split data
    const { error } = await db.from('orders').update({ 
        status: 'Completed', 
        payment_split: splitData 
    }).eq('id', id);

    if (error) {
        showToast("Error completing order", true);
    } else {
        closeModal('paymentModal');
        window.fetchOrders();
        showToast("Order Completed & Synced");
    }
    setBtnLoading(btn, false);
};

// --- SHIFT RESET LOGIC ---
let shiftBaseId = 0; // The ID of the first order of the shift

async function fetchShiftBaseId() {
    // 1. Calculate Shift Start (5:00 PM Logic)
    const now = new Date();
    const shiftStart = new Date();
    
    // If it's before 5:00 AM, we are still in "Yesterday's" shift (technically)
    // (User said they close at 3:30 AM, so 5 AM is a safe "Cutoff")
    if (now.getHours() < 5) {
        shiftStart.setDate(now.getDate() - 1);
    }
    shiftStart.setHours(17, 0, 0, 0); // Set to 5:00 PM

    // 2. Find the VERY FIRST order ID created after 5 PM
    const { data } = await db.from('orders')
        .select('id')
        .gte('created_at', shiftStart.toISOString())
        .order('id', {ascending: true})
        .limit(1)
        .single();

    // 3. Store it. If no orders yet, base is 0.
    shiftBaseId = data ? data.id : 0;
    console.log("Shift starts at ID:", shiftBaseId);
}


        
        // --- PRINTER BRANDING LOGIC ---

// 1. Fetch Logo on Load (Add this to initAdmin)
window.fetchPrinterSettings = async () => {
    const { data } = await db.from('settings').select('data').eq('id', 'printer_branding').single();
    if (data?.data?.logo) {
        printerLogoUrl = data.data.logo;
        
        // Update UI
        document.getElementById('printer-logo-preview').src = printerLogoUrl;
        document.getElementById('printer-logo-preview').classList.remove('hidden');
        document.getElementById('btn-rm-printer-logo').classList.remove('hidden');
        document.getElementById('printer-logo-placeholder').classList.add('hidden');
    }
}

// 2. Save Logo Setting
window.savePrinterSettings = async (btn) => {
    setBtnLoading(btn, true);
    
    const payload = { logo: printerLogoUrl };
    const { error } = await db.from('settings').upsert({ id: 'printer_branding', data: payload });
    
    if (error) showToast("Save failed", true);
    else showToast("Branding Saved");
    
    setBtnLoading(btn, false);
}

// 3. Remove Logo Logic
window.removePrinterLogo = () => {
    printerLogoUrl = "";
    document.getElementById('printer-logo-preview').src = "";
    document.getElementById('printer-logo-preview').classList.add('hidden');
    document.getElementById('btn-rm-printer-logo').classList.add('hidden');
    document.getElementById('printer-logo-placeholder').classList.remove('hidden');
    document.getElementById('printer-logo-input').value = ""; // Reset input
}

// 4. Update the Finish Crop Function (Add this line)
// Inside finishCrop(), add this check:
/* if(cropType === 'printer-logo') { 
       printerLogoUrl = url; 
       document.getElementById('printer-logo-preview').src = url; 
       document.getElementById('printer-logo-preview').classList.remove('hidden'); 
       document.getElementById('btn-rm-printer-logo').classList.remove('hidden');
       document.getElementById('printer-logo-placeholder').classList.add('hidden');
   } 
*/

        // --- CATEGORY MANAGER ---
let allCats = ["Burger", "Fries", "Drink"]; // Default Fallback
let allMenuItems = [];

window.fetchCategories = async () => {
    // Try to fetch from settings
    const { data } = await db.from('settings').select('data').eq('id', 'menu_categories').single();
    if(data?.data?.categories) {
        allCats = data.data.categories;
    }
    renderCategories();
};

// Global variable to track the sorter (Put this right above the function)
let catSortable = null; 
let orderRefreshTimer = null;

window.renderCategories = () => {
    const grid = document.getElementById('cats-grid');
    
    // 1. Render the HTML
    grid.innerHTML = allCats.map((cat, index) => `
        <div class="glass-card p-4 flex justify-between items-center group relative" data-cat="${cat}">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-grip-vertical text-slate-300 cursor-move hover:text-orange-500 transition"></i>
                
                <span class="font-bold text-lg text-slate-700">
                    <i class="fa-solid fa-tag text-slate-300 mr-2"></i> ${cat}
                </span>
            </div>
            <button onclick="deleteCategory(${index})" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                <i class="fa-solid fa-trash text-xs"></i>
            </button>
        </div>
    `).join('');
    
    // 2. Update the "Add Item" Dropdown
    const dropdown = document.getElementById('m-cat');
    if(dropdown) dropdown.innerHTML = allCats.map(c => `<option value="${c}">${c}</option>`).join('');

    // --- THE FIX: DESTROY OLD INSTANCE FIRST ---
    if (catSortable) {
        catSortable.destroy();
        catSortable = null;
    }

    // 3. Create New Sorter
    catSortable = new Sortable(grid, {
        animation: 150,
        handle: '.cursor-move',
        ghostClass: 'sortable-ghost',
        onEnd: async () => {
            // Get new order
            const newOrder = Array.from(grid.children).map(el => el.dataset.cat);
            allCats = newOrder;
            
            await saveCategoriesToDb();
            showToast("Category Order Saved");
            
            // Re-render safely after a tiny delay (Prevents the "Stuck" bug)
            setTimeout(() => renderCategories(), 50);
        }
    });
};

window.printLatestOrder = async () => {
    // 1. Find the most recent order ID from the database
    const { data } = await db.from('orders')
                             .select('id')
                             .order('created_at', {ascending: false})
                             .limit(1)
                             .single();
    
    // 2. If we found one, print it. If not, alert the user.
    if (data && data.id) {
        showToast(`Printing Test (Order #${data.id})`);
        printOrderReceipt(data.id);
    } else {
        showToast("No orders found in database!", true);
    }
};



// --- PRINTER LOGIC ---

// Variable to store the printer logo URL
let printerLogoUrl = ""; 

// --- OPTIMIZED RECEIPT GENERATOR (No Popups / Instant) ---
window.printOrderReceipt = async (orderId, forceLang = null) => {
    // 1. Fetch Data
    const { data: order } = await db.from('orders').select('*').eq('id', orderId).single();
    if (!order) return showToast("Order not found", true);

    const { data: user } = await db.from('users').select('name, phone').eq('id', order.user_id).single();
    const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
    // Calculate Daily Number
let printNum = order.id;
if(shiftBaseId > 0 && order.id >= shiftBaseId) {
    printNum = order.id - shiftBaseId + 1;
}

    // 2. Determine Language
    // If forceLang is set, strictly follow it. Else, fall back to order language.
const isArabic = forceLang ? (forceLang === 'ar') : (order.lang === 'ar');



    // 3. Build HTML
    let tempDiv = document.createElement("div");
    tempDiv.style.position = "absolute";
    tempDiv.style.top = "-9999px";
    tempDiv.style.left = "0";
    tempDiv.style.width = "576px"; // 80mm
    tempDiv.style.background = "#fff";
    tempDiv.style.color = "#000"; 
    
    // FONT & DIRECTION SETTINGS
    if (isArabic) {
        tempDiv.style.fontFamily = "'Tajawal', sans-serif"; 
        tempDiv.style.direction = "rtl";
        tempDiv.style.textAlign = "right";
    } else {
        tempDiv.style.fontFamily = "'Plus Jakarta Sans', sans-serif";
        tempDiv.style.direction = "ltr";
        tempDiv.style.textAlign = "center";
    }

    // TRANSLATION DICTIONARY
    const t = isArabic ? {
        title: "", 
        orderNum: "", 
        custDetails: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ",
        guest: "ÿπŸÖŸäŸÑ ÿ≤ÿßÿ¶ÿ±",
        subtotal: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä",
        discount: "ÿÆÿµŸÖ",
        total: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
        kitchenNote: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑŸÖÿ∑ÿ®ÿÆ",
        footer: "ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ≤Ÿäÿßÿ±ÿ™ŸÉŸÖ",
        payType: (order.payment_method || 'Cash').toUpperCase().includes('CASH') ? 'ŸÜŸÇÿØ ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ' : 'ÿØŸÅÿπ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä',
        currency: "ÿ±ŸäÿßŸÑ"
    } : {
        title: "Official Receipt",
        orderNum: "Order Number",
        custDetails: "Customer Details",
        guest: "Guest Customer",
        subtotal: "Subtotal",
        discount: "Discount",
        total: "TOTAL",
        kitchenNote: "Kitchen Note",
        footer: "Thank you for dining with us.",
        payType: (order.payment_method || 'CASH').toUpperCase(),
        currency: "SR"
    };

    const formatPrice = (amount) => {
        if (isArabic) {
            return `${amount.toFixed(2)} <span style="font-size: 60%; font-weight: 700;">${t.currency}</span>`;
        } else {
            return `${t.currency} ${amount.toFixed(2)}`;
        }
    };

    const renderItems = () => {
        return items.map(i => {
            const name = isArabic ? (translationMap[i.name] || i.name) : i.name;
            const modsHTML = (i.selectedMods && i.selectedMods.length > 0) 
                ? i.selectedMods.map(m => {
                    const modName = isArabic ? (translationMap[m.name] || m.name) : m.name;
                    return `+ ${modName}`;
                }).join('<br>')
                : '';

            return `
            <div style="margin-bottom: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <span style="font-weight:800; font-size:22px; width:75%; line-height:1.2; color:#000;">${i.qty}x ${name}</span>
                    <span style="font-weight:800; font-size:22px; color:#000;">${formatPrice(i.qty * i.unitPrice)}</span>
                </div>
                ${modsHTML ? `<div style="font-size:18px; font-weight:700; margin-top:6px; color:#000; padding-${isArabic?'right':'left'}:15px; border-${isArabic?'right':'left'}:4px solid #000;">${modsHTML}</div>` : ''}
            </div>`;
        }).join('');
    };

    // --- HTML STRUCTURE ---
    tempDiv.innerHTML = `
        <div style="padding: 40px 20px; border-bottom: 4px solid #000;">
            
            <div style="text-align:center; margin-bottom: 20px;">
                ${printerLogoUrl ? `<img src="${printerLogoUrl}" style="width:200px; height:auto; display:block; margin:0 auto 15px auto;">` : ''}
                <h1 style="margin:0; font-size:45px; font-weight:900; letter-spacing: -2px; text-transform:uppercase; color:#000;">TARI.</h1>
                ${t.title ? `<p style="margin:5px 0 0 0; font-size:18px; font-weight:700; color:#000;">${t.title}</p>` : ''}
            </div>

            <div style="text-align:center; margin-bottom: 40px;">
                ${t.orderNum ? `<span style="display:block; font-size:16px; font-weight:900; text-transform:uppercase; letter-spacing:2px; margin-bottom:5px; color:#000;">${t.orderNum}</span>` : ''}
                <span style="display:block; font-size:70px; font-weight:900; line-height:1; color:#000;">#${printNum}</span>
            </div>

            <div style="margin-bottom: 30px; padding-bottom: 25px; border-bottom: 3px dashed #000; text-align: ${isArabic ? 'right' : 'center'};">
                <div style="font-size:16px; font-weight:900; color:#000; text-transform:uppercase; margin-bottom:8px;">${t.custDetails}</div>
                <div style="font-size:28px; font-weight:800; margin-bottom: 4px; color:#000;">${user?.name || t.guest}</div>
                <div style="font-size:22px; font-weight:700; color:#000;">${user?.phone || ""}</div>
                <div style="font-size:16px; font-weight:600; color:#000; margin-top:8px;">${new Date(order.created_at).toLocaleString('en-US')}</div>
            </div>

            <div style="margin-bottom: 30px; text-align: ${isArabic ? 'right' : 'left'};">
                ${renderItems()}
            </div>

            <div style="border-top: 3px dashed #000; padding-top: 25px; margin-bottom: 40px;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px; font-size:20px; font-weight:700; color:#000;">
                    <span>${t.subtotal}</span>
                    <span>${formatPrice(order.subtotal || order.total)}</span>
                </div>
                 ${order.promo_code ? `
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px; font-size:20px; font-weight:700; color:#000;">
                    <span>${t.discount} (${order.promo_code})</span>
                    <span>- ${formatPrice(order.subtotal - order.total)}</span>
                </div>` : ''}
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 20px;">
                    <span style="font-size:32px; font-weight:900; color:#000;">${t.total}</span>
                    <span style="font-size:48px; font-weight:900; color:#000;">${formatPrice(order.total)}</span>
                </div>
            </div>

            <div style="text-align:center; display:flex; flex-direction: column; align-items:center;">
                
                <div style="display:inline-flex; align-items:center; justify-content:center; height:50px; padding: 0 40px; background:#000; color:#fff; font-weight:800; border-radius:50px; font-size:20px; margin-bottom: 30px;">
                    <span style="position:relative; top:-2px;">${t.payType}</span>
                </div>
                
                ${order.note ? `
                <div style="width:100%; border: 3px solid #000; padding:15px; border-radius:12px; text-align:${isArabic?'right':'left'}; margin-bottom:25px;">
                    <span style="font-size:16px; font-weight:900; text-transform:uppercase; display:block; margin-bottom:5px; color:#000;">${t.kitchenNote}:</span>
                    <span style="font-size:22px; font-weight:800; color:#000;">${order.note}</span>
                </div>` : ''}
                
                <p style="font-size:18px; font-weight:700; color:#000; font-family:'Tajawal'">${t.footer}</p>
            </div>
        </div>
    `;

    document.body.appendChild(tempDiv);

    try {
        // --- COMPRESSION MAGIC (Prevents Popup) ---
        const canvas = await html2canvas(tempDiv, { scale: 1.2, useCORS: true, logging: false });
        document.body.removeChild(tempDiv);
        
        // Use JPEG with 0.6 quality (Tiny File Size = Instant Transfer)
        const imgData = canvas.toDataURL("image/jpeg", 0.6);
        const base64Content = imgData.split(',')[1]; 

        // 1. Try Silent Print (Localhost)
        try {
            const response = await fetch('http://localhost:40213/printimage', {
                method: 'POST',
                body: base64Content
            });
            if(response.ok) { return; } // Success! No popup.
        } catch (e) {}

        // 2. Fallback (If Silent Fails)
        window.location.href = 'rawbt:' + imgData;

    } catch (err) {
        console.error(err);
        if(tempDiv && tempDiv.parentNode) document.body.removeChild(tempDiv);
        alert("Print Error");
    }
}


// 2. Toggle Auto Print Setting
window.toggleAutoPrint = (checked) => {
    localStorage.setItem('tari_auto_print', checked);
    if(checked) showToast("Auto Accept & Print ON");
    else showToast("Auto Print OFF");
}



// --- UPDATED DELETE FUNCTION ---
window.deleteCategory = async (index) => {
    // 1. Trigger the New Elegant Window (instead of the old confirm())
    const userSaidYes = await showConfirm("Do you really want to delete this category?");
    
    // 2. If they clicked "Cancel", stop here.
    if (!userSaidYes) return;
    
    // 3. If they clicked "Yes", delete it.
    allCats.splice(index, 1);
    await saveCategoriesToDb();
    renderCategories();
    showToast("Category Deleted");
};


window.saveCategoriesToDb = async () => {
    await db.from('settings').upsert({ id: 'menu_categories', data: { categories: allCats } });
};

        // RENAMED TO AVOID CONFLICT
        let db; 
let ordersChannel = null;
// --- RESTORE MISSING VARIABLES ---
const notificationAudio = new Audio();

window.checkPermissionStatus = () => {
    if(!('Notification' in window)) return;
    const p = Notification.permission;
    
    // Safety check in case elements don't exist yet
    const statusText = document.getElementById('perm-status');
    const statusDot = document.getElementById('perm-indicator');

    if(statusText) statusText.innerText = p === 'granted' ? "Active" : "Blocked/Default";
    if(statusDot) statusDot.className = p === 'granted' ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-orange-500";
};

        // Force Loader Hide (Safety Net)
        setTimeout(() => {
            const p = document.getElementById('preloader');
            if(p && !p.classList.contains('loaded')) {
                p.classList.add('loaded');
            }
        }, 3000);
        
        // --- ADD CATEGORY FUNCTION (This was missing!) ---
window.addCategory = async () => {
    const input = document.getElementById('new-cat-name');
    const val = input.value.trim();
    
    // 1. Validation
    if(!val) return showToast("Enter a name", true);
    
    // 2. Add to Local List
    allCats.push(val);
    
    // 3. Save to Database
    await saveCategoriesToDb();
    
    // 4. Update UI
    input.value = ""; // Clear input
    renderCategories(); // Refresh grid
    showToast("Category Added");
};


// --- 1. THE CUSTOM POPUP LOGIC ---
let confirmResolver = null;

window.showConfirm = (msg) => {
    const modal = document.getElementById('confirmModal');
    const box = document.getElementById('confirmBox');
    
    document.getElementById('confirmMsg').innerText = msg;
    
    // Show & Animate
    modal.classList.remove('hidden');
    // Tiny timeout to let the browser render before fading in
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        box.classList.remove('scale-95');
        box.classList.add('scale-100');
    }, 10);

    // Wait for user answer
    return new Promise((resolve) => {
        confirmResolver = resolve;
    });
};

window.resolveConfirm = (result) => {
    const modal = document.getElementById('confirmModal');
    const box = document.getElementById('confirmBox');
    
    // Hide & Animate
    modal.classList.add('opacity-0');
    box.classList.remove('scale-100');
    box.classList.add('scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        if(confirmResolver) confirmResolver(result);
        confirmResolver = null;
    }, 200);
};

// --- TRANSLATION MANAGER ---
let translationMap = {};

window.fetchTranslations = async () => {
    // 1. Fetch the saved translations from 'settings' table
    const { data } = await db.from('settings').select('data').eq('id', 'app_translations').single();
    if (data?.data) translationMap = data.data;
    
    renderTranslationUI();
};

window.renderTranslationUI = () => {
    // 1. Render Categories
    const catContainer = document.getElementById('trans-cat-list');
    catContainer.innerHTML = allCats.map(cat => `
        <div class="glass-card p-4 flex flex-col gap-2">
            <span class="text-xs font-bold text-slate-400 uppercase">Category</span>
            <div class="font-bold text-slate-800 text-lg mb-1">${cat}</div>
            <input class="trans-input input-box bg-slate-50 border-slate-200 text-right font-medium text-blue-600" 
                   dir="rtl"
                   data-key="${cat}" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[cat] || ""}">
        </div>`).join('');

    // 2. Render Menu Items (With Big Textarea & RTL)
    const itemContainer = document.getElementById('trans-item-list');
    itemContainer.innerHTML = allMenuItems.map(item => {
        const arabicName = translationMap[item.name] || "";
        const arabicDesc = translationMap[item.name + "_desc"] || ""; 
        
        return `
        <div class="glass-card p-4 flex flex-col md:flex-row gap-4 items-start">
            <img src="${item.image || 'https://via.placeholder.com/50'}" class="w-16 h-16 rounded-lg object-cover bg-slate-50">
            
            <div class="flex-1 w-full">
                <div class="flex justify-between mb-1">
                    <span class="font-bold text-slate-800">${item.name}</span>
                    <span class="text-xs font-bold text-slate-400">SR ${item.price}</span>
                </div>
                
                <input class="trans-input input-box mb-3 text-right text-sm font-bold" 
                       dir="rtl"
                       data-key="${item.name}" 
                       placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" 
                       value="${arabicName}">
                
                ${item.description ? `
                <p class="text-[10px] text-slate-400 mb-2 italic leading-relaxed">${item.description}</p>
                
                <textarea class="trans-input input-box text-right text-xs text-slate-600 min-h-[80px] resize-y leading-relaxed p-3" 
                       dir="rtl"
                       data-key="${item.name}_desc" 
                       placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä... (ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ)">${arabicDesc}</textarea>
                ` : ''}
            </div>
        </div>`;
    }).join('');

    
        // 3. Render Splash Screen (Updated)
    const splashContainer = document.getElementById('trans-splash-list');
    const currentTitle = document.getElementById('splash-title').value || "TARI";
    const currentIntro = document.getElementById('splash-intro').value || "";
    
    splashContainer.innerHTML = `
        <div class="glass-card p-4">
            <span class="text-xs font-bold text-slate-400 uppercase">Main Title</span>
            <div class="font-bold text-slate-800 text-lg mb-2">${currentTitle}</div>
            
            <textarea class="trans-input input-box text-right min-h-[80px] resize-y" 
                      dir="rtl" 
                      data-key="${currentTitle}" 
                      placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä (ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑŸÑŸÜÿ≤ŸàŸÑ)">${translationMap[currentTitle] || ""}</textarea>
        </div>

        <div class="glass-card p-4">
            <span class="text-xs font-bold text-slate-400 uppercase">Intro Text</span>
            <div class="text-sm text-slate-600 mb-2">${currentIntro}</div>
            <textarea class="trans-input input-box text-right h-20" dir="rtl" data-key="${currentIntro}" placeholder="ÿßŸÑŸÜÿµ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä">${translationMap[currentIntro] || ""}</textarea>
        </div>
    `;


    // 4. Render Modifiers
    const modContainer = document.getElementById('trans-mod-list');
    modContainer.innerHTML = allMods.map(group => {
        const options = typeof group.options === 'string' ? JSON.parse(group.options) : group.options;
        
        const optionsHtml = options.map(opt => `
            <div class="flex items-center gap-3 mt-2 pl-4 border-l-2 border-slate-100">
                <span class="text-xs font-bold text-slate-500 w-1/3">${opt.name}</span>
                <input class="trans-input input-box py-1 text-right text-xs w-2/3" 
                       dir="rtl"
                       data-key="${opt.name}" placeholder="ÿßŸÑÿÆŸäÿßÿ± ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[opt.name] || ""}">
            </div>
        `).join('');

        return `
        <div class="glass-card p-4">
            <div class="mb-3">
                <span class="text-xs font-bold text-orange-500 uppercase">Group Name</span>
                <div class="flex gap-3 mt-1">
                    <span class="font-bold text-slate-800 w-1/3 pt-2">${group.name}</span>
                    <input class="trans-input input-box text-right w-2/3" dir="rtl" data-key="${group.name}" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä" value="${translationMap[group.name] || ""}">
                </div>
            </div>
            <div class="bg-slate-50 rounded-xl p-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Options</span>
                ${optionsHtml}
            </div>
        </div>`;
    }).join('');
    // --- 5. BUSINESS INFO (ADDRESS + DAYS + TIME) ---
    const infoContainer = document.getElementById('trans-info-container');
    if(infoContainer) {
        const currentAddr = document.getElementById('info-loc').value || "Address";
        
        // A. Extract Unique Days
        const uniqueDays = [...new Set(workingHours.map(h => h.day).filter(d => d))];
        
        // B. Extract Unique Times (NEW!)
        const uniqueTimes = [...new Set(workingHours.map(h => h.time).filter(t => t))];

        // C. Build HTML for Days
        let daysHtml = uniqueDays.map(day => `
            <div class="flex items-center justify-between gap-4 mt-3 border-b border-slate-50 pb-2 last:border-0">
                <span class="font-bold text-slate-600 text-sm">${day}</span>
                <input class="trans-input input-box w-2/3 text-right text-sm"
                       dir="rtl"
                       data-key="${day}"
                       placeholder="ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä (ŸÖÿ´ÿßŸÑ: ÿßŸÑÿ£ÿ≠ÿØ)"
                       value="${translationMap[day] || ""}">
            </div>
        `).join('');

        // D. Build HTML for Times (NEW!)
        let timesHtml = uniqueTimes.map(time => `
            <div class="flex items-center justify-between gap-4 mt-3 border-b border-slate-50 pb-2 last:border-0">
                <span class="font-bold text-slate-600 text-sm" dir="ltr">${time}</span>
                <input class="trans-input input-box w-2/3 text-right text-sm"
                       dir="rtl"
                       data-key="${time}"
                       placeholder="ÿßŸÑŸàŸÇÿ™ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä (ŸÖÿ´ÿßŸÑ: Ÿ• ŸÖ - Ÿ°Ÿ¢ ÿµ)"
                       value="${translationMap[time] || ""}">
            </div>
        `).join('');

        // E. Render Everything
        infoContainer.innerHTML = `
            <div class="glass-card p-4 mb-4">
                <span class="text-xs font-bold text-slate-400 uppercase">Store Location</span>
                <div class="font-bold text-slate-800 text-lg mb-2">${currentAddr}</div>
                <textarea class="trans-input input-box text-right h-20 resize-none" 
                          dir="rtl" 
                          data-key="store_address_ar" 
                          placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä">${translationMap['store_address_ar'] || ""}</textarea>
            </div>

            <div class="glass-card p-4 mb-4">
                <span class="text-xs font-bold text-slate-400 uppercase mb-2 block">Day Names</span>
                ${daysHtml.length ? daysHtml : '<p class="text-xs text-red-400 italic">No days found.</p>'}
            </div>

            <div class="glass-card p-4">
                <span class="text-xs font-bold text-slate-400 uppercase mb-2 block">Time Slots</span>
                ${timesHtml.length ? timesHtml : '<p class="text-xs text-red-400 italic">No times found.</p>'}
            </div>
        `;
    }
};




window.saveTranslations = async (btn) => {
    setBtnLoading(btn, true);
    
    // 1. Gather all inputs
    const inputs = document.querySelectorAll('.trans-input');
    const newMap = {};
    
    inputs.forEach(input => {
        const key = input.dataset.key;
        const val = input.value.trim();
        if (val) newMap[key] = val; // Only save if not empty
    });
    
    // 2. Save to Database
    const { error } = await db.from('settings').upsert({ 
        id: 'app_translations', 
        data: newMap 
    });
    
    if (error) {
        showToast("Error saving", true);
    } else {
        translationMap = newMap;
        showToast("Translations Published!");
    }
    setBtnLoading(btn, false);
};

// IMPORTANT: Add 'fetchTranslations()' to your initAdmin list!

        // DYNAMIC LOADER
                // --- 1. ROBUST SUPABASE LOADER (Self-Healing) ---
        function loadSupabaseLib() {
            // Safety check: If already loaded, just init
            if (window.supabase && window.supabase.createClient) {
                initSupabaseClient();
                return;
            }

            const script = document.createElement('script');
            // Use UMD build to guarantee 'window.supabase' availability
            script.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js";
            script.async = true;

            script.onload = () => initSupabaseClient();

            script.onerror = () => {
                console.warn("Primary CDN failed, trying backup...");
                const backup = document.createElement('script');
                backup.src = "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js";
                backup.onload = () => initSupabaseClient();
                document.body.appendChild(backup);
            };

            document.body.appendChild(script);
        }

        function initSupabaseClient() {
            try {
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error("Supabase library not found on window object.");
                }

                // Initialize DB with Realtime throttling to prevent socket overload
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: false
                    },
                    realtime: {
                        params: {
                            eventsPerSecond: 10, // Limit events to prevent crashes
                        },
                    },
                });

                checkAuth();

            } catch (e) {
                console.error("Supabase Init Error:", e);
                // AUTO-FIX: If init crashes, cache is likely corrupt. Clear and reload.
                localStorage.clear();
                location.reload();
            }
        }

        // --- 2. AUTH CHECK WITH TIMEOUT (Prevents "Loading..." Freeze) ---
        function checkAuth() {
            if (!db) {
                // If DB isn't ready yet, wait a split second and retry
                setTimeout(checkAuth, 500);
                return;
            }

            // KILL SWITCH: If Supabase doesn't answer in 5 seconds, reset the app.
            // This fixes the "Need to clear browser data" bug.
            const authTimeout = setTimeout(() => {
                console.warn("‚ö†Ô∏è Auth check timed out - clearing ghost session.");
                localStorage.clear();
                location.reload();
            }, 5000);

            db.auth.getSession().then(({ data }) => {
                clearTimeout(authTimeout); // We got an answer, cancel the kill switch

                if (data?.session) {
                    document.getElementById('auth-overlay')?.classList.add('hidden');
                    initAdmin(); // Success - Start App
                } else {
                    document.getElementById('preloader')?.classList.add('loaded');
                    document.getElementById('auth-overlay')?.classList.remove('hidden');
                }
            }).catch(err => {
                clearTimeout(authTimeout); // Cancel kill switch on known error
                console.error("Auth Error:", err);
                document.getElementById('preloader')?.classList.add('loaded');
                document.getElementById('auth-overlay')?.classList.remove('hidden');
            });
        }

        // --- AUTH & LOGIN ---
        window.handleAdminLogin = async () => { 
            if (!db) return alert("Connecting...");
            const btn = document.getElementById('btn-unlock');
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-pass').value;

            if (!email || !pass) return alert("Please enter email and password");

            btn.innerText = "Checking...";
            btn.disabled = true;

            const { data, error } = await db.auth.signInWithPassword({ email, password: pass }); 
            
            if (error) {
                alert("Login Failed: " + error.message);
                btn.innerText = "Unlock";
                btn.disabled = false;
            } else { 
                btn.innerText = "Success!";
                btn.classList.add('bg-green-600');
                
                // Unlock Audio
                notificationAudio.src = "https://assets.mixkit.co/sfx/preview/mixkit-service-bell-ring-1461.mp3"; 
                notificationAudio.play().then(() => { 
                    notificationAudio.pause(); 
                    notificationAudio.currentTime = 0; 
                }).catch(e => console.log("Audio unlock failed"));
                
                setTimeout(() => {
                    document.getElementById('auth-overlay').classList.add('hidden'); 
                    initAdmin();
                }, 500);
            } 
        };
        
        window.logout = async () => { await db.auth.signOut(); location.reload(); };

// --- 3. BULLETPROOF REALTIME ENGINE ---
let isConnecting = false;
let realtimeRetries = 0;

async function startOrdersRealtime() {
    // STOP GAP: If we are already connecting or connected, do nothing.
    if (isConnecting) return;
    if (ordersChannel && (ordersChannel.state === 'joined' || ordersChannel.state === 'joining')) {
        console.log("üõ°Ô∏è Connection already alive.");
        return;
    }

    isConnecting = true;

    // 1. CLEANUP: Force remove old channel to free memory
    if (ordersChannel) {
        try {
            await db.removeChannel(ordersChannel);
        } catch (e) { console.warn("Cleanup warning (non-fatal)"); }
        ordersChannel = null;
    }

    console.log("üîå Establishing Fresh Connection...");
    
    // 2. FIXED NAME: Don't use Date.now(). Use a static room name.
    const channelName = 'room_orders_main'; 

    ordersChannel = db.channel(channelName)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
            // Reset retry counter on successful data packet
            realtimeRetries = 0;
            
            if (payload.eventType === 'INSERT') {
                playNotification();
                fetchShiftBaseId();
            }
            
            // Debounce refresh (wait 500ms before refreshing UI)
            if (orderRefreshTimer) clearTimeout(orderRefreshTimer);
            orderRefreshTimer = setTimeout(() => {
                fetchOrders();
                fetchDashboard();
            }, 500);
        })
        .subscribe((status) => {
            console.log(`üì° Status: ${status}`);
            
            if (status === 'SUBSCRIBED') {
                isConnecting = false;
                realtimeRetries = 0;
                showToast("Kitchen Live üü¢");
                document.getElementById('live-count').classList.remove('text-red-500');
            } 
            else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                isConnecting = false; // Allow retry
                document.getElementById('live-count').classList.add('text-red-500');
                
                // Smart Retry Logic
                handleRealtimeError();
            }
        });
}

function handleRealtimeError() {
    if(realtimeRetries > 5) {
        showToast("Connection Unstable - Refreshing...", true);
        setTimeout(() => location.reload(), 2000); // Hard refresh if 5 fails
        return;
    }

    realtimeRetries++;
    const delay = Math.min(1000 * (2 ** realtimeRetries), 10000); // 2s, 4s, 8s...
    console.log(`‚ö†Ô∏è Retrying in ${delay}ms (Attempt ${realtimeRetries})`);
    
    setTimeout(() => {
        startOrdersRealtime();
    }, delay);
}


        // --- INIT APP ---
        async function initAdmin() { 
    // 1. Calculate the Shift Offset FIRST
    await fetchShiftBaseId();
            // 1. Initial Data Fetch
            Promise.all([
                fetchOrders(), fetchMods(), fetchMenu(), fetchCategories(),
                fetchSettings(), fetchPromos(), fetchNewUserPromo(), 
                fetchTranslations(),
                fetchSoundSettings(),
                fetchCustomers(), 
                fetchLoyalty(),
                fetchDesign(), fetchInfo(), fetchDashboard(), fetchHistory(),
                fetchStoreStatus(),
                fetchPrinterSettings(), checkPermissionStatus(), fetchWebsiteSettings()
            ]).catch(err => console.error("Init Partial Error", err));

            // 2. Setup Realtime Listener
            startOrdersRealtime();
       
            // 3. Setup Sound
            const savedSound = localStorage.getItem('tari_sound') || 'bell';
            document.getElementById('sound-select').value = savedSound;
            if(savedSound === 'custom' && localStorage.getItem('tari_custom_sound')) {
                document.getElementById('custom-sound-upload').classList.remove('hidden');
                document.getElementById('custom-file-name').innerText = "Custom sound loaded";
            }
        }

        // --- WEBSITE SETTINGS ---
        let webLogo="", webBgImg="";
                window.fetchWebsiteSettings = async () => {
            const { data } = await db.from('settings').select('data').eq('id', 'website_settings').single();
            if(data?.data) {
                document.getElementById('web-header-color').value = data.data.header_color || "#ffffff";
                document.getElementById('web-bg-color').value = data.data.bg_color || "#F8FAFC";
                
                if(data.data.logo) { 
                    webLogo = data.data.logo; 
                    document.getElementById('web-logo-preview').src = webLogo; 
                    document.getElementById('web-logo-preview').classList.remove('hidden'); 
                }
                
                // FIXED: Show Preview AND Remove Button if image exists
                if(data.data.bg_image) { 
                    webBgImg = data.data.bg_image; 
                    document.getElementById('web-bg-img-preview').src = webBgImg; 
                    document.getElementById('web-bg-img-preview').classList.remove('hidden'); 
                    document.getElementById('btn-remove-bg').classList.remove('hidden'); // <--- Shows the button
                }
            }
        }


               // NEW: Clears the background image
window.removeWebBg = () => {
    if(!confirm("Remove the background image?")) return;
    
    webBgImg = ""; // Clear the variable
    
    // Hide the preview and the button
    document.getElementById('web-bg-img-preview').classList.add('hidden');
    document.getElementById('web-bg-img-preview').src = "";
    document.getElementById('btn-remove-bg').classList.add('hidden');
    
    // Clear the input so you can re-upload the same file if needed
    document.getElementById('web-bg-img-input').value = "";
}

                window.saveWebsiteSettings = async (btn) => {
            setBtnLoading(btn, true);
            const payload = {
                logo: webLogo,
                bg_image: webBgImg,
                header_color: document.getElementById('web-header-color').value,
                bg_color: document.getElementById('web-bg-color').value
            };
            
            // FIXED: Now we actually CHECK if it saved!
            const { error } = await db.from('settings').upsert({ id: 'website_settings', data: payload });
            
            if (error) {
                console.error("Save Error:", error);
                showToast("Save Failed: " + error.message, true); // <--- Shows you the real error
            } else {
                showToast("Website Updated");
            }
            setBtnLoading(btn, false);
        }

        // --- HELPERS ---
        window.setBtnLoading = (btn, isLoading) => { if(!btn) return; if(isLoading){ btn.dataset.org = btn.innerText; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...'; btn.disabled = true; } else { btn.innerHTML = btn.dataset.org; btn.disabled = false; } };
        window.showToast = (msg, isErr = false) => { const t = document.getElementById('toast-container'); document.getElementById('toast-msg').innerText = msg; t.querySelector('i').className = isErr ? "fa-solid fa-circle-xmark text-red-400 text-lg" : "fa-solid fa-circle-check text-green-400 text-lg"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('sidebar-open'); document.getElementById('sidebar-overlay').classList.toggle('overlay-active'); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchTab = (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(document.getElementById('nav-'+t)) document.getElementById('nav-'+t).classList.add('active'); if(window.innerWidth < 768) { document.getElementById('sidebar').classList.remove('sidebar-open'); document.getElementById('sidebar-overlay').classList.remove('overlay-active'); } };
        window.switchMenuSub = (t) => { 
    document.getElementById('view-items').classList.toggle('hidden', t!=='items'); 
    document.getElementById('view-mods').classList.toggle('hidden', t!=='mods'); 
    document.getElementById('view-cats').classList.toggle('hidden', t!=='cats'); // New line

    // Update Buttons Styling
    const setBtn = (id, active) => {
        const el = document.getElementById(id);
        el.className = active 
            ? "px-6 py-2.5 rounded-lg font-bold text-sm transition-all shadow-sm bg-white text-slate-900"
            : "px-6 py-2.5 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-900";
    };
    setBtn('sub-items', t==='items');
    setBtn('sub-mods', t==='mods');
    setBtn('sub-cats', t==='cats');
};


        // --- CROPPER ---
        let cropper, cropType; 
        window.startCrop = (input, type) => { 
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                cropType = type; 
                const img = document.getElementById('crop-target');
                img.src = e.target.result; 
                document.getElementById('crop-modal').classList.remove('hidden');
                document.getElementById('crop-modal').classList.add('active'); 
                if(cropper) cropper.destroy(); 
                cropper = new Cropper(img, { aspectRatio: NaN, autoCropArea: 1 }); 
                input.value = ""; 
            }; 
            reader.readAsDataURL(input.files[0]); 
        }; 
        window.closeCropper = () => { document.getElementById('crop-modal').classList.remove('active'); setTimeout(()=>document.getElementById('crop-modal').classList.add('hidden'), 300); if(cropper) cropper.destroy(); }; 
                // FIXED: Saves as PNG to keep transparent backgrounds (Logos/Icons)
        window.finishCrop = () => { 
            if(!cropper) return;

            // 1. Configure crop to keep transparency (fillColor: 'transparent')
            cropper.getCroppedCanvas({
                maxWidth: 800, 
                fillColor: 'transparent' 
            }).toBlob(async blob => { 
                
                showToast("Uploading...", false);
                // 2. Change file extension to .png
                const name = `upload-${Date.now()}.png`; 
                
                const { data, error } = await db.storage.from('images').upload(name, blob); 
                
                if (error) { showToast("Upload Failed", true); return; }

                const url = db.storage.from('images').getPublicUrl(name).data.publicUrl; 
                
                
                // Logic to put the image in the right place
                if(cropType === 'hero') {
                    heroImages.push(url);
                    document.getElementById('hero-list-container').innerHTML = heroImages.map((u,i) => `<div class="relative w-full h-24 rounded-lg overflow-hidden"><img src="${u}" class="w-full h-full object-cover"><button onclick="delHeroImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>`).join('');
                }

                if(cropType === 'menu') { menuImgUrl = url; document.getElementById('m-img-preview').src = url; document.getElementById('m-img-preview').classList.remove('hidden'); } 
                if(cropType === 'splash-bg') { splashBg = url; document.getElementById('splash-bg-preview').src = url; document.getElementById('splash-bg-preview').classList.remove('hidden'); } 
                if(cropType === 'splash-c') { splashC = url; document.getElementById('splash-c-preview').src = url; document.getElementById('splash-c-preview').classList.remove('hidden'); } 
                if(cropType === 'web-logo') { webLogo = url; document.getElementById('web-logo-preview').src = url; document.getElementById('web-logo-preview').classList.remove('hidden'); }
                if(cropType === 'web-bg') { webBgImg = url; document.getElementById('web-bg-img-preview').src = url; document.getElementById('web-bg-img-preview').classList.remove('hidden'); }
                // E. PRINTER LOGO (The Missing Part)
        if(cropType === 'printer-logo') { 
            printerLogoUrl = url; 
            
            // Show the image
            document.getElementById('printer-logo-preview').src = url; 
            document.getElementById('printer-logo-preview').classList.remove('hidden'); 
            
            // Show remove button & hide placeholder
            document.getElementById('btn-rm-printer-logo').classList.remove('hidden');
            document.getElementById('printer-logo-placeholder').classList.add('hidden');
        }
                
                closeCropper(); showToast("Image Set");

            }, 'image/png'); // <--- CRITICAL CHANGE: Saves as PNG
        };

        // --- NOTIFICATIONS & PERMISSIONS ---
        // --- CLOUD UPLOAD & SYNC (The "Menu Images" Way) ---
window.uploadCustomSound = async (input) => {
    const file = input.files[0];
    if (!file) return;

    // 1. Validation (Max 2MB)
    if (file.size > 2 * 1024 * 1024) {
        alert("‚ö†Ô∏è Sound file is too big (Max 2MB)");
        input.value = "";
        return;
    }

    // Show Loading
    const labelSpan = input.parentElement.querySelector('span');
    const originalText = labelSpan.innerText;
    labelSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

    try {
        // 2. Upload to Supabase Storage
        const fileExt = file.name.split('.').pop();
        const fileName = `custom-${Date.now()}.${fileExt}`;
        
        const { error: uploadError } = await db.storage
            .from('sounds')
            .upload(fileName, file);

        if (uploadError) throw uploadError;

        // 3. Get Public URL
        const { data } = db.storage.from('sounds').getPublicUrl(fileName);
        const publicUrl = data.publicUrl;

        // 4. SAVE TO DATABASE (Settings Table)
        // This syncs the new sound to ALL devices immediately
        const { error: dbError } = await db.from('settings').upsert({ 
            id: 'sound_config', 
            data: { 
                type: 'custom', 
                custom_url: publicUrl 
            } 
        });

        if (dbError) throw dbError;

        // 5. Update UI & Global Variable
        document.getElementById('sound-select').value = 'custom';
        document.getElementById('custom-file-name').innerText = "cloud_audio.mp3";
        
        // Update global config immediately
        window.soundConfig = { type: 'custom', custom_url: publicUrl };

        showToast("Sound Saved to Cloud ‚òÅÔ∏è");

    } catch (err) {
        console.error("Upload Error:", err);
        showToast("Upload Failed", true);
    } finally {
        labelSpan.innerText = originalText;
        input.value = "";
    }
};

        // --- 3. ROBUST NOTIFICATION SYSTEM (Supabase Hosted & Crash-Proof) ---
window.playNotification = (title = "New Order!", body = "Check Kitchen Board") => {
    // A. Get the user's preference
    // Safety: Check if element exists first
    const soundSelect = document.getElementById('sound-select');
    const soundType = soundSelect ? soundSelect.value : 'bell';
    let audioUrl = "";

    // B. Determine Source (Safe Mode)
    // Check if soundConfig is loaded, otherwise fallback
    const config = window.soundConfig || { type: 'bell', custom_url: '' };

    if (config.type === 'custom') {
        audioUrl = config.custom_url;
    } else {
        // Defaults from your 'sounds' bucket
        // Ensure you have uploaded: bell.mp3, chime.mp3, tech.mp3
        audioUrl = `https://fpgspmhgwcmhaaxsphcd.supabase.co/storage/v1/object/public/sounds/${soundType}.mp3`;
    }

    // C. Play with Loop
    if (audioUrl && typeof notificationAudio !== 'undefined') {
        notificationAudio.src = audioUrl;
        notificationAudio.loop = true; // Loop until touched
        
        notificationAudio.play().catch(e => {
            console.warn("Audio autoplay blocked. User must tap screen first.", e);
        });
    }

    // D. Vibration
    if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);

    // E. Native Notification (CRASH FIX HERE)
    // We strictly check ('Notification' in window) BEFORE accessing Notification.permission
    if ('Notification' in window && Notification.permission === 'granted' && 'serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(reg => {
            try {
                reg.showNotification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/9703/9703596.png',
                    tag: 'new-order',
                    requireInteraction: true
                });
            } catch (e) {
                console.log("Service Worker Notification failed", e);
            }
        });
    }
};

// --- 4. SILENCE ON TOUCH ---
window.addEventListener('click', () => {
    if (typeof notificationAudio !== 'undefined' && !notificationAudio.paused) {
        notificationAudio.pause();
        notificationAudio.currentTime = 0; 
    }
}, { capture: true });

        window.saveSoundSettings = async () => {
    const type = document.getElementById('sound-select').value;
    
    // Toggle the upload box visibility
    document.getElementById('custom-sound-upload').classList.toggle('hidden', type !== 'custom');

    // Update Global Config
    window.soundConfig.type = type;

    // Save preference to DB
    // We keep 'custom_url' so if they switch back to custom later, the file is still there
    await db.from('settings').upsert({ 
        id: 'sound_config', 
        data: window.soundConfig 
    });

    showToast("Sound Preference Saved");
}

        // 2. Request Permission (Improved)
window.requestNotificationPermission = async () => {
    if (!('Notification' in window)) return showToast("Not Supported", true);
    
    const res = await Notification.requestPermission();
    checkPermissionStatus(); // Your existing UI updater
    
    if(res === 'granted') { 
        showToast("Notifications Active"); 
        // Send a test native notification
        playNotification("Test Order", "System is ready!");
        // Try to keep screen awake (prevent sleep)
        try { if(navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}
    } else { 
        showToast("Permission Denied", true);
    }
}

        // --- STORE ---
        window.fetchStoreStatus = async () => {
            const { data } = await db.from('settings').select('data').eq('id', 'store_status').single();
            const isOpen = data?.data?.open || false;
            document.getElementById('store-toggle-d').checked = isOpen;
            document.getElementById('store-toggle-m').checked = isOpen;
            updateStoreLabel(isOpen);
        }
        window.toggleStore = async (status) => {
            document.getElementById('store-toggle-d').checked = status;
            document.getElementById('store-toggle-m').checked = status;
            updateStoreLabel(status);
            await db.from('settings').upsert({ id: 'store_status', data: { open: status } });
            showToast(status ? "Store Opened" : "Store Closed");
        }
        function updateStoreLabel(status) {
            const el = document.getElementById('store-status-text-d');
            el.innerText = status ? "Store Open" : "Store Closed";
            el.className = status ? "text-sm font-bold text-green-600" : "text-sm font-bold text-slate-600";
        }

        // --- FETCHERS ---
        window.fetchDashboard = async () => { const today = new Date().toISOString().split('T')[0]; const { data: orders } = await db.from('orders').select('*').gte('created_at', today + 'T00:00:00'); const totalOrders = orders ? orders.length : 0; const totalRevenue = orders ? orders.reduce((sum, o) => sum + o.total, 0) : 0; let items = {}; (orders||[]).forEach(o => { if(typeof o.items === 'string') o.items = JSON.parse(o.items); if(Array.isArray(o.items)) o.items.forEach(i => items[i.name] = (items[i.name] || 0) + i.qty); }); const topItem = Object.keys(items).reduce((a, b) => items[a] > items[b] ? a : b, "--"); document.getElementById('dash-orders').innerText = totalOrders; document.getElementById('dash-revenue').innerText = 'SR ' + totalRevenue.toFixed(2); document.getElementById('dash-top-item').innerText = topItem; document.getElementById('dash-activity').innerHTML = (orders||[]).slice(-5).reverse().map(o => `<div class="flex justify-between items-center"><span class="font-bold text-slate-700">Order #${o.id}</span><span class="text-xs text-slate-400">${new Date(o.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>`).join(''); };
        // Variable to store ID for the print button in modal
let currentHistoryId = null;

window.fetchHistory = async () => { 
    const { data: orders } = await db.from('orders').select('*')
        .eq('status', 'Completed')
        .order('created_at', {ascending: false})
        .limit(20);
        
    document.getElementById('history-list').innerHTML = (orders||[]).map(o => `
        <tr class="hover:bg-slate-50 transition">
            <td class="p-4 font-bold text-slate-700">#${o.id}</td>
            <td class="p-4 text-slate-500 text-xs">
                ${new Date(o.created_at).toLocaleDateString()}<br>
                ${new Date(o.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
            </td>
            <td class="p-4 text-xs font-medium">
                ${(typeof o.items === 'string' ? JSON.parse(o.items) : o.items).length} items
            </td>
            <td class="p-4 font-black text-orange-500">SR ${o.total.toFixed(2)}</td>
            <td class="p-4">
                <div class="flex items-center gap-2">
                    <span class="bg-slate-100 px-2 py-1 rounded text-[10px] font-bold uppercase text-slate-500">${o.payment_method || 'Cash'}</span>
                    <button onclick="openHistoryModal(${o.id})" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-blue-600 hover:border-blue-200 shadow-sm flex items-center justify-center transition">
                        <i class="fa-solid fa-eye text-xs"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join(''); 
};

window.openHistoryModal = async (id) => {
    currentHistoryId = id; // Store for the print button
    
    // 1. Show Loading
    const container = document.getElementById('history-modal-content');
    container.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-orange-500"></i></div>';
    document.getElementById('historyModal').classList.remove('hidden');

    // 2. Fetch Fresh Data (for user details)
    const { data: order } = await db.from('orders').select('*').eq('id', id).single();
    const { data: user } = await db.from('users').select('name, phone').eq('id', order.user_id).single();
    const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;

// --- FIX START: Calculate printNum here ---
    let printNum = order.id;
    if(shiftBaseId > 0 && order.id >= shiftBaseId) {
        printNum = order.id - shiftBaseId + 1;
    }
    // 3. Render HTML (Visual representation, not the print canvas)
    container.innerHTML = `
        <div class="text-center mb-6">
            <h2 class="text-3xl font-black text-slate-800">#${printNum}</h2>
            <p class="text-sm text-slate-500 font-bold">${new Date(order.created_at).toLocaleString()}</p>
        </div>
        
        <div class="bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100">
            <div class="text-xs font-bold text-slate-400 uppercase mb-1">Customer</div>
            <div class="font-bold text-lg text-slate-800">${user?.name || 'Guest'}</div>
            <div class="text-sm text-slate-500">${user?.phone || 'No Phone'}</div>
        </div>

        <div class="space-y-4 mb-6">
            ${items.map(i => `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-slate-700">${i.qty}x ${i.name}</div>
                        ${i.selectedMods ? `<div class="text-xs text-slate-400 pl-2 border-l-2 border-slate-200 mt-1">${i.selectedMods.map(m=>m.name).join(', ')}</div>` : ''}
                    </div>
                    <div class="font-bold text-slate-900">SR ${(i.qty * i.unitPrice).toFixed(0)}</div>
                </div>
            `).join('')}
        </div>

        <div class="border-t border-dashed border-slate-300 pt-4">
             <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-bold text-slate-500">Total</span>
                <span class="text-2xl font-black text-slate-900">SR ${order.total.toFixed(2)}</span>
            </div>
             <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400">Payment</span>
                <span class="text-xs font-bold bg-green-100 text-green-600 px-2 py-1 rounded uppercase">${order.payment_method || 'Cash'}</span>
            </div>
        </div>
    `;
};

        let currentOrderToAccept = null;
                
window.fetchOrders = async () => {
    // OPTIMIZATION: Only fetch orders that are NOT Completed and NOT Cancelled
    const { data: orders } = await db.from('orders')
        .select('*')
        .neq('status', 'Completed') 
        .neq('status', 'Cancelled')
        .order('created_at', {ascending: true});
       
    // Optimize: Fetch users
    const { data: users } = await db.from('users').select('id, name, phone');
    const userMap = {}; 
    (users||[]).forEach(u => userMap[u.id] = { name: u.name, phone: u.phone });
    
    // 2. Prepare Containers
    const colNew = document.getElementById('col-new'); 
    const colCooking = document.getElementById('col-cooking'); 
    const colReady = document.getElementById('col-ready');
    
    let htmlNew = '', htmlCooking = '', htmlReady = '';
    let activeCount = 0;
    
    (orders||[]).forEach(o => {
    const dailyNum = shiftBaseId > 0 ? (o.id - shiftBaseId + 1) : o.id;
        if(o.status === 'Completed') return;
        activeCount++;
        
        // --- DETECT LANGUAGE ---
        const isAr = o.lang === 'ar'; 
        const dir = isAr ? 'rtl' : 'ltr';
        const align = isAr ? 'text-right' : 'text-left';
        
        // Match User
        const userObj = userMap[o.user_id] || { name: "Guest", phone: "" };
        const uName = userObj.name || "Guest";
        
        // Phone HTML
        const uPhone = userObj.phone 
            ? `<div class="text-xs text-slate-500 font-bold mt-1 bg-slate-100 px-2 py-1 rounded w-fit flex items-center gap-1" dir="ltr">
                 <i class="fa-solid fa-phone text-[10px]"></i> ${userObj.phone}
               </div>` 
            : `<div class="text-[10px] text-red-300 font-bold mt-1">No Phone</div>`;

        const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
        
        // Time Calc
        const time = Math.floor((new Date() - new Date(o.created_at)) / 60000) + 'm';
        
        // Buttons
        let nextAction = `openTimeModal(${o.id})`, btnTxt = isAr ? "ŸÇÿ®ŸàŸÑ ÿßŸÑÿ∑ŸÑÿ®" : "Accept", btnColor = "bg-slate-800";
        if(o.status === 'Preparing' || o.status === 'Cooking') { 
            nextAction = `updateStatus(${o.id}, 'Ready')`; 
            btnTxt = isAr ? "ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ≥ŸÑŸäŸÖ" : "Mark Ready"; 
            btnColor = "bg-orange-500"; 
        }
        if(o.status === 'Ready') { 
            nextAction = `updateStatus(${o.id}, 'Completed')`; 
            btnTxt = isAr ? "ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®" : "Complete"; 
            btnColor = "bg-green-600"; 
        }

                // --- RENDER ITEMS (WITH TRANSLATION) ---
        const itemsHtml = items.map(i => { 
            const displayName = isAr ? (translationMap[i.name] || i.name) : i.name;
            
            // 1. DEFINE THE BADGE
            const isGift = i.isLoyalty === true;
            const giftBadge = isGift 
                ? `<span class="bg-purple-100 text-purple-600 text-[10px] font-bold px-1.5 py-0.5 rounded mx-1 uppercase shadow-sm"><i class="fa-solid fa-gift"></i> Gift</span>` 
                : '';

            let modsHtml = ''; 
            if(i.selectedMods && i.selectedMods.length > 0) {
                const modList = i.selectedMods.map(m => isAr ? (translationMap[m.name] || m.name) : m.name).join(isAr ? 'ÿå ' : ', ');
                modsHtml = `<div class="text-xs text-red-500 ${isAr ? 'pr-2 border-r-2 border-red-200 mr-1' : 'pl-2 border-l-2 border-red-200 ml-1'} mt-1 font-bold">${modList}</div>`; 
            }
            
            return `
            <div class="flex justify-between items-start mb-2 border-b border-slate-50 pb-2 last:border-0 last:pb-0">
                <div class="${align}">
                    <span class="font-bold text-slate-700 text-sm flex flex-wrap items-center">
                        ${i.qty}x ${displayName} ${giftBadge} </span>
                    ${modsHtml}
                </div>
                <span class="font-bold text-slate-900 text-xs whitespace-nowrap" dir="ltr">SR ${(i.qty * i.unitPrice).toFixed(2)}</span>
            </div>`; 
        }).join('');

        
        const payBadge = `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[10px] font-bold uppercase flex items-center gap-1"><i class="fa-solid fa-credit-card"></i> ${o.payment_method || 'Cash'}</span>`;
        
        const totalLabel = isAr ? "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä" : "Total";
        const promoHtml = o.promo_code 
            ? `<div class="flex justify-between items-center text-xs mt-1"><span class="text-slate-400 font-bold">${totalLabel}</span><div dir="ltr"><span class="line-through text-slate-400 mr-2">${o.subtotal.toFixed(2)}</span><span class="font-black text-green-600 text-lg">SR ${o.total.toFixed(2)}</span></div></div><div class="text-xs text-purple-500 font-bold mt-1">Promo: ${o.promo_code}</div>` 
            : `<div class="flex justify-between items-center mt-2"><span class="text-xs text-slate-400 font-bold uppercase">${totalLabel}</span><span class="font-black text-slate-900 text-lg" dir="ltr">SR ${o.total.toFixed(2)}</span></div>`;
        
        // --- CARD HTML (FIXED RTL) ---
        // 1. dir="${dir}" handles the main swap.
        // 2. We REMOVED 'flex-row-reverse'. Just 'flex justify-between' with dir="rtl" automatically puts the first child on the Right.
        const card = `
        <div class="glass-card p-4 mb-3 animate-[fadeIn_0.3s]" dir="${dir}">
            <div class="flex justify-between mb-3">
                <div class="${align}">
                    <span class="font-black text-2xl text-orange-500">#${dailyNum}</span>
<span class="text-[10px] text-slate-300 font-bold ml-2">ID:${o.id}</span>
 
                    <span class="text-sm text-slate-800 font-bold block">${uName}</span>
                    ${uPhone}
                </div>
                <div class="flex flex-col ${isAr ? 'items-start' : 'items-end'}">
                    <span class="font-bold text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded h-fit mb-1" dir="ltr">${time}</span>
                    ${payBadge}
                </div>
            </div>
            
            <div class="bg-slate-50 p-3 rounded-xl mb-3 border border-slate-100">
                ${itemsHtml}
            </div>
            
            ${promoHtml}
            
            ${o.note ? `<div class="text-xs bg-red-50 text-red-500 p-2 rounded mt-3 font-bold ${align}"><i class="fa-solid fa-note-sticky mx-1"></i> ${o.note}</div>` : ''}
            
            <button onclick="${nextAction}" class="w-full py-3 rounded-lg text-white font-bold text-sm ${btnColor} shadow-lg active:scale-95 transition mt-4 hover:opacity-90">${btnTxt}</button>
        </div>`;
        
        if(o.status === 'New Order') htmlNew += card; 
        else if(o.status === 'Preparing' || o.status === 'Cooking') htmlCooking += card; 
        else if(o.status === 'Ready') htmlReady += card;
    });

    colNew.innerHTML = htmlNew;
    colCooking.innerHTML = htmlCooking;
    colReady.innerHTML = htmlReady;
    
    document.getElementById('live-count').innerText = activeCount; 
    document.getElementById('mobile-live-count').innerText = activeCount;
};




        // --- SMART TIMER LOGIC ---

window.openTimeModal = (id) => { 
    currentOrderToAccept = id; 
    document.getElementById('timeModal').classList.remove('hidden'); 
    
    // Reset Everything
    document.getElementById('custom-time').value = ''; 
    clearTimeSelection(); 
};
        window.selectTime = (mins, btn) => { 
    // 1. Set the hidden value
    document.getElementById('custom-time').value = mins; 
    
    // 2. Visual Feedback (Highlight button)
    clearTimeSelection();
    if(btn) btn.classList.add('active');
};

window.clearTimeSelection = () => {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
};

window.confirmTime = async () => { 
    const inputVal = document.getElementById('custom-time').value;
    const selectedMins = parseInt(inputVal) || 15;

    const btn = document.querySelector('#timeModal .btn-main');
    setBtnLoading(btn, true);

    try {
        const { data: order } = await db.from('orders').select('created_at').eq('id', currentOrderToAccept).single();
        if (!order) throw new Error("Order not found");

        const createdAt = new Date(order.created_at).getTime();
        const now = Date.now();
        
        // 1. Calculate how many minutes have passed since order came in
        const minutesPassed = (now - createdAt) / 60000; 
        
        // 2. Add passed time to selected time
        // Example: If order sat for 2.5 mins, and you chose 15, total is 17.5
        const preciseTotal = minutesPassed + selectedMins;

        // 3. THE FIX: Math.floor() removes the decimal (17.5 -> 17)
        // This stops the database crash AND keeps the timer from jumping up to "16"
        const realMinutesToSave = Math.floor(preciseTotal);

        // 4. Update Database
        await db.from('orders').update({ 
            status: 'Preparing', 
            estimated_mins: realMinutesToSave 
        }).eq('id', currentOrderToAccept);
        
          // --- AUTO PRINT CHECK (THIS IS THE FIX) ---
        // We check if the toggle is 'true' in localStorage
        const autoPrint = localStorage.getItem('tari_auto_print') === 'true';
        if(autoPrint) {
            // Wait a tiny bit for the toast to show, then print
            setTimeout(() => {
                printOrderReceipt(currentOrderToAccept);
            }, 500);
        }

        closeModal('timeModal'); 
        window.fetchOrders(); 
        showToast(`Order Started (${selectedMins}m)`); 
    
    } catch (e) {
        showToast("Error starting order", true);
        console.error("Timer Error:", e);
    }
    
    setBtnLoading(btn, false); 
};

      

        let allMods = []; let editMenuId = null; let editModId = null; let menuImgUrl = "";
        window.fetchMods = async () => { const { data } = await db.from('modifier_groups').select('*').order('sort_order', {ascending: true}); allMods = data || []; renderMods(); };
        function renderMods() { 
    const grid = document.getElementById('modifiers-grid'); 
    
    grid.innerHTML = allMods.map(g => {
        const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
        const optionsHtml = options.map(o => `<span class="text-[10px] bg-slate-50 border border-slate-200 px-2 py-1 rounded-md text-slate-600 font-bold">${o.name}</span>`).join('');
        
        return `
        <div class="glass-card p-4 relative flex items-center gap-4 group" data-id="${g.id}">
            <div class="cursor-move text-slate-300 px-2 py-2 hover:text-orange-500 transition">
                <i class="fa-solid fa-grip-vertical text-lg"></i>
            </div>

            <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                    <h4 class="font-bold text-slate-800 text-sm">${g.name}</h4>
                    ${g.required ? '<span class="text-[9px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded font-bold uppercase border border-red-100">Required</span>' : ''}
                </div>
                <div class="flex flex-wrap gap-2">${optionsHtml}</div>
            </div>

            <div class="flex gap-3 pl-4 border-l border-slate-50">
                <button onclick='editMod(${JSON.stringify(g).replace(/'/g, "&#39;")})' class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pen"></i></button>
                <button onclick="delMod(${g.id})" class="text-slate-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`;
    }).join(''); 

    // AUTO-SAVE SORTABLE
    new Sortable(grid, { 
        animation: 150, 
        handle: '.cursor-move', 
        ghostClass: 'sortable-ghost', 
        onEnd: async () => {
            // 1. Get new order from DOM
            const newOrder = Array.from(grid.children).map((el, index) => ({
                id: el.dataset.id,
                sort_order: index
            }));

            // 2. Save to Database Immediately
            await Promise.all(newOrder.map(item => 
                db.from('modifier_groups').update({ sort_order: item.sort_order }).eq('id', item.id)
            ));

            showToast("Modifiers Saved");
        } 
    }); 
}


        window.openModModal = () => { editModId = null; document.getElementById('mod-modal-title').innerText="Create Group"; document.getElementById('mod-group-name').value=""; document.getElementById('mod-options-container').innerHTML=""; window.addModOptionInput(); document.getElementById('modModal').classList.remove('hidden'); };
        window.editMod = (g) => { editModId = g.id; document.getElementById('mod-modal-title').innerText="Edit Group"; document.getElementById('mod-group-name').value = g.name; document.getElementById('mod-required').checked = g.required; document.getElementById('mod-options-container').innerHTML = ""; (typeof g.options === 'string' ? JSON.parse(g.options) : g.options).forEach(o => window.addModOptionInput(o.name, o.price)); document.getElementById('modModal').classList.remove('hidden'); };
        // --- UPDATED MODIFIER LOGIC ---

// Now accepts a 3rd argument: 'lid' (Loyverse ID)
window.addModOptionInput = (name = "", price = "", lid = "") => {
    document.getElementById('mod-options-container').insertAdjacentHTML('beforeend', `
        <div class="flex gap-2 mb-2 option-row items-center">
            <input placeholder="Opt Name" class="input-box py-2 text-sm flex-1" value="${name}">
            <input type="number" placeholder="Price" class="input-box py-2 text-sm w-20" value="${price}">
            <input placeholder="Loy ID (Optional)" class="input-box py-2 text-[10px] w-24 font-mono text-blue-500" value="${lid}">
            <i class="fa-solid fa-xmark text-slate-300 cursor-pointer hover:text-red-500" onclick="this.parentElement.remove()"></i>
        </div>
    `);
};

window.editMod = (g) => { 
    editModId = g.id; 
    document.getElementById('mod-modal-title').innerText="Edit Group"; 
    document.getElementById('mod-group-name').value = g.name; 
    document.getElementById('mod-required').checked = g.required; 
    document.getElementById('mod-options-container').innerHTML = ""; 
    
    const options = typeof g.options === 'string' ? JSON.parse(g.options) : g.options;
    
    // Pass the saved ID to the input generator
    options.forEach(o => window.addModOptionInput(o.name, o.price, o.loyverse_id || "")); 
    
    document.getElementById('modModal').classList.remove('hidden'); 
};

window.saveModGroup = async (btn) => { 
    setBtnLoading(btn, true); 
    const name = document.getElementById('mod-group-name').value; 
    
    // Capture the 3rd input (Loyverse ID)
    const options = Array.from(document.querySelectorAll('.option-row')).map(r => ({ 
        name: r.children[0].value, 
        price: r.children[1].value,
        loyverse_id: r.children[2].value.trim() // Save it!
    })); 
    
    const payload = { name, options, required: document.getElementById('mod-required').checked }; 
    
    let err; 
    if(editModId) { 
        const {error} = await db.from('modifier_groups').update(payload).eq('id', editModId); 
        err=error; 
    } else { 
        const {error} = await db.from('modifier_groups').insert(payload); 
        err=error; 
    } 
    
    setBtnLoading(btn, false); 
    if(err) showToast(err.message, true); 
    else { closeModal('modModal'); window.fetchMods(); showToast("Modifiers Saved"); } 
};

        // 2. DELETE MODIFIER GROUP
      window.delMod = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Delete this modifier group?")) return;

    // Proceed to Delete
    const { error } = await db.from('modifier_groups').delete().eq('id', id);
    if(error) {
        showToast("Error deleting group", true);
    } else {
        showToast("Group deleted");
        fetchMods(); // Refresh Grid
    }
};
        window.fetchMenu = async () => { 
    // 1. Fetch Data
    const { data } = await db.from('menu').select('*').order('sort_order', {ascending: true}); 
    
    // 2. Save to Global Variable (So Translation Manager can see it!)
    allMenuItems = data || [];

    // 3. Render Grid
    const grid = document.getElementById('menu-grid'); 
    grid.innerHTML = (allMenuItems).map(i => `
        <div class="glass-card flex gap-3 p-3 relative ${i.available===false?'item-off':''}" data-id="${i.id}">
            <div class="absolute left-2 top-1/2 -translate-y-1/2 cursor-move text-slate-300 px-2 py-4 hover:text-orange-500 transition">
                <i class="fa-solid fa-grip-vertical"></i>
            </div>
            
            <img src="${i.image||'https://via.placeholder.com/50'}" class="w-16 h-16 rounded-lg object-cover bg-slate-50 ml-8">
            
            <div class="flex-1">
                <h4 class="font-bold text-sm">${i.name}</h4>
                <p class="text-orange-500 font-bold text-xs">SR ${i.price}</p>
                <div class="flex gap-2 mt-1">
                    ${i.is_best_seller ? '<span class="text-[9px] bg-yellow-100 text-yellow-600 px-1.5 rounded font-bold">BEST</span>' : ''}
                    ${i.available===false ? '<span class="text-[9px] bg-red-100 text-red-600 px-1.5 rounded font-bold">OFF</span>' : ''}
                </div>
            </div>
            
            <div class="absolute top-3 right-3 flex gap-4">
                <button onclick='editItem(${JSON.stringify(i).replace(/'/g, "&#39;")})' class="text-slate-300 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button>
                <button onclick="toggleAvailability(${i.id}, ${i.available})" class="text-slate-300 hover:text-green-500"><i class="fa-solid fa-power-off"></i></button>
                <button onclick="toggleBest(${i.id}, ${i.is_best_seller})" class="text-slate-300 hover:text-yellow-500"><i class="fa-solid fa-star"></i></button>
                <button onclick="delItem(${i.id})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
    `).join(''); 
    
    // 4. Setup Drag & Drop
    new Sortable(grid, { 
        animation: 150, 
        handle: '.cursor-move', 
        ghostClass: 'sortable-ghost', 
        onEnd: async () => {
            const newOrder = Array.from(grid.children).map((el, index) => ({
                id: el.dataset.id,
                sort_order: index
            }));
            await Promise.all(newOrder.map(item => 
                db.from('menu').update({ sort_order: item.sort_order }).eq('id', item.id)
            ));
            showToast("Menu Order Saved");
        } 
    }); 

    // 5. Refresh Translations UI (The Fix)
    if(typeof fetchTranslations === 'function') {
        fetchTranslations();
    }
};



   
        window.saveMenuOrder = async (btn) => { setBtnLoading(btn, true); const items = Array.from(document.getElementById('menu-grid').children).map((el, index) => ({ id: el.dataset.id, sort_order: index })); const mods = Array.from(document.getElementById('modifiers-grid').children).map((el, index) => ({ id: el.dataset.id, sort_order: index })); for (const item of items) await db.from('menu').update({ sort_order: item.sort_order }).eq('id', item.id); for (const mod of mods) await db.from('modifier_groups').update({ sort_order: mod.sort_order }).eq('id', mod.id); showToast("Order Saved"); document.getElementById('save-order-btn').classList.add('hidden'); setBtnLoading(btn, false); };
        window.toggleAvailability = async (id, status) => { await db.from('menu').update({ available: !status }).eq('id', id); window.fetchMenu(); showToast("Updated"); };
        window.toggleBest = async (id, status) => { await db.from('menu').update({ is_best_seller: !status }).eq('id', id); window.fetchMenu(); showToast("Updated"); };
        // --- UPDATED MENU ITEM LOGIC ---

window.openMenuModal = async () => { // Make async
    // Check if categories are loaded, if not, wait for them
    if(document.getElementById('m-cat').children.length <= 1) {
        await fetchCategories();
    }
    
    editMenuId = null; 
    document.getElementById('menu-modal-title').innerText="Add New Item";  
    document.getElementById('menu-modal-title').innerText="Add New Item"; 
    
    // Clear Fields
    document.getElementById('m-name').value=""; 
    document.getElementById('m-price').value=""; 
    document.getElementById('m-desc').value=""; 
    document.getElementById('m-cat').value=""; 
    
    // NEW: Clear Loyverse ID
    const idField = document.getElementById('m-loyverse-id');
    if(idField) idField.value = ""; 

    menuImgUrl=""; 
    document.getElementById('m-img-preview').classList.add('hidden'); 
    document.getElementById('m-available').checked=true; 
    document.getElementById('m-best').checked=false; 
    
    document.getElementById('item-modifier-list').innerHTML = allMods.map(g => 
        `<label class="flex items-center gap-2 text-sm p-2 border rounded"><input type="checkbox" value="${g.id}" class="mod-check accent-orange-500"> ${g.name}</label>`
    ).join(''); 
    
    document.getElementById('menuModal').classList.remove('hidden'); 
};

window.editItem = (i) => { 
    editMenuId = i.id; 
    document.getElementById('menu-modal-title').innerText="Edit Item"; 
    
    // Populate Fields
    menuImgUrl = i.image; 
    document.getElementById('m-name').value = i.name; 
    document.getElementById('m-price').value = i.price; 
    document.getElementById('m-cat').value = i.category || ""; 
    document.getElementById('m-desc').value = i.description || ""; 
    
    // NEW: Load Loyverse ID
    const idField = document.getElementById('m-loyverse-id');
    if(idField) idField.value = i.loyverse_id || ""; 

    document.getElementById('m-available').checked = i.available !== false; 
    document.getElementById('m-best').checked = i.is_best_seller === true; 
    
    if(i.image) { 
        document.getElementById('m-img-preview').src = i.image; 
        document.getElementById('m-img-preview').classList.remove('hidden'); 
    } 
    
    document.getElementById('item-modifier-list').innerHTML = allMods.map(g => 
        `<label class="flex items-center gap-2 text-sm p-2 border rounded"><input type="checkbox" value="${g.id}" class="mod-check accent-orange-500" ${(i.modifier_group_ids||[]).includes(g.id) ? 'checked' : ''}> ${g.name}</label>`
    ).join(''); 
    
    document.getElementById('menuModal').classList.remove('hidden'); 
};

window.saveMenuItem = async (btn) => { 
    setBtnLoading(btn, true); 
    const mods = Array.from(document.querySelectorAll('.mod-check:checked')).map(c => parseInt(c.value)); 
    
    // NEW: Grab the ID
    const loyId = document.getElementById('m-loyverse-id') ? document.getElementById('m-loyverse-id').value.trim() : null;

    const payload = { 
        name: document.getElementById('m-name').value, 
        price: parseFloat(document.getElementById('m-price').value), 
        description: document.getElementById('m-desc').value, 
        image: menuImgUrl, 
        category: document.getElementById('m-cat').value, 
        modifier_group_ids: mods, 
        available: document.getElementById('m-available').checked, 
        is_best_seller: document.getElementById('m-best').checked,
        
        // Save to DB
        loyverse_id: loyId
    }; 
    
    try { 
        let { error } = editMenuId 
            ? await db.from('menu').update(payload).eq('id', editMenuId) 
            : await db.from('menu').insert(payload); 
            
        if(error) throw error; 
        
        closeModal('menuModal'); 
        window.fetchMenu(); 
        showToast("Item Saved"); 
    } catch(err) { 
        showToast(err.message, true); 
    } 
    setBtnLoading(btn, false); 
};

        window.delItem = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Delete this food item permanently?")) return;

    // Proceed to Delete
    const { error } = await db.from('menu').delete().eq('id', id);
    if(error) {
        showToast("Error deleting item", true);
    } else {
        showToast("Item deleted");
        fetchMenu(); // Refresh Grid
    }
};

// Global Variable for Sound
window.soundConfig = { type: 'bell', custom_url: '' };

window.fetchSoundSettings = async () => {
    const { data } = await db.from('settings').select('data').eq('id', 'sound_config').single();
    
    if (data?.data) {
        window.soundConfig = data.data;
        
        // Update UI
        document.getElementById('sound-select').value = window.soundConfig.type || 'bell';
        
        // Show/Hide Upload Box
        if (window.soundConfig.type === 'custom') {
            document.getElementById('custom-sound-upload').classList.remove('hidden');
            if(window.soundConfig.custom_url) {
                document.getElementById('custom-file-name').innerText = "Current: Cloud File";
            }
        }
    }
}

        window.fetchSettings = async () => { const { data: splash } = await db.from('settings').select('data').eq('id', 'splash').single(); if(splash?.data) { document.getElementById('splash-title').value = splash.data.title||""; document.getElementById('splash-intro').value = splash.data.intro||""; if(splash.data.background) { splashBg = splash.data.background; document.getElementById('splash-bg-preview').src = splashBg; document.getElementById('splash-bg-preview').classList.remove('hidden'); } } const { data: hero } = await db.from('settings').select('data').eq('id', 'hero').single(); if(hero?.data) { document.getElementById('hero-list-container').innerHTML = (hero.data.images||[]).map((u,i) => `<div class="relative w-full h-24 rounded-lg overflow-hidden"><img src="${u}" class="w-full h-full object-cover"><button onclick="delHeroImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>`).join(''); heroImages = hero.data.images || []; } };
                window.fetchDesign = async () => { 
            const { data } = await db.from('settings').select('data').eq('id', 'design').single(); 
            if(data?.data) {
                // Load Primary Color
                document.getElementById('design-color').value = data.data.primaryColor || "#FF5722";
                // Load Background Color (New)
                document.getElementById('design-bg-color').value = data.data.backgroundColor || "#F8FAFC";
            } 
        };
        let heroImages = [], splashBg="", splashC="";
        window.saveSplashSettings = async (btn) => { setBtnLoading(btn, true); await db.from('settings').upsert({ id: 'splash', data: { title: document.getElementById('splash-title').value, intro: document.getElementById('splash-intro').value, background: splashBg, circle: splashC } }); showToast("Splash Saved"); setBtnLoading(btn, false); };
        window.saveHeroSettings = async (btn) => { setBtnLoading(btn, true); await db.from('settings').upsert({ id: 'hero', data: { images: heroImages } }); showToast("Hero Saved"); setBtnLoading(btn, false); };
        window.delHeroImg = (i) => { heroImages.splice(i,1); window.saveHeroSettings(); window.fetchSettings(); };
                window.saveDesign = async (btn) => { 
            setBtnLoading(btn, true); 
            
            const payload = { 
                primaryColor: document.getElementById('design-color').value,
                backgroundColor: document.getElementById('design-bg-color').value
            };

            await db.from('settings').upsert({ id: 'design', data: payload }); 
            showToast("Design Saved"); 
            setBtnLoading(btn, false); 
        };
        let workingHours = []; 
        window.fetchInfo = async () => { 
    const { data } = await db.from('settings').select('data').eq('id', 'info').single(); 
    if(data?.data) { 
        const d = data.data; 
        document.getElementById('info-loc').value = d.location || ""; 
        
        // --- NEW MAPS LOGIC ---
        const mapLink = d.maps_link || "";
        document.getElementById('info-maps').value = mapLink;
        
        // Show test button if link exists
        const testBtn = document.getElementById('btn-test-map');
        if(mapLink) {
            testBtn.href = mapLink;
            testBtn.classList.remove('hidden');
        } else {
            testBtn.classList.add('hidden');
        }
        // ----------------------

        document.getElementById('info-phone').value = d.phone || ""; 
        document.getElementById('info-insta').value = d.instagram || ""; 
        document.getElementById('info-twit').value = d.twitter || ""; 
        document.getElementById('info-tik').value = d.tiktok || ""; 
        workingHours = d.hours || []; 
        renderHours(workingHours); 
    } 
};
        function renderHours(hoursData) { workingHours = hoursData; document.getElementById('hours-container').innerHTML = workingHours.map((h, i) => `<div class="flex gap-2 items-center mb-2"><input value="${h.day}" placeholder="Day" class="input-box py-2 w-1/3" onchange="updateHour(${i}, 'day', this.value)"><input value="${h.time}" placeholder="Time" class="input-box py-2 w-2/3" onchange="updateHour(${i}, 'time', this.value)"><button onclick="removeHour(${i})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></div>`).join(''); } 
        window.addHourRow = () => { workingHours.push({day:'', time:''}); renderHours(workingHours); }; 
        window.updateHour = (i, key, val) => { workingHours[i][key] = val; }; 
        window.removeHour = (i) => { workingHours.splice(i, 1); renderHours(workingHours); }; 
        window.saveInfo = async (btn) => { 
    setBtnLoading(btn, true); 
    
    const payload = { 
        location: document.getElementById('info-loc').value, 
        maps_link: document.getElementById('info-maps').value, // <--- SAVING MAP LINK
        phone: document.getElementById('info-phone').value, 
        instagram: document.getElementById('info-insta').value, 
        twitter: document.getElementById('info-twit').value, 
        tiktok: document.getElementById('info-tik').value, 
        hours: workingHours 
    }; 
    
    await db.from('settings').upsert({ id: 'info', data: payload }); 
    showToast("Info Saved"); 
    
    // Refresh the test button immediately
    const testBtn = document.getElementById('btn-test-map');
    if(payload.maps_link) {
        testBtn.href = payload.maps_link;
        testBtn.classList.remove('hidden');
    }

    setBtnLoading(btn, false); 
};
        window.fetchPromos = async () => { const { data } = await db.from('promocodes').select('*'); document.getElementById('promo-list').innerHTML = (data||[]).map(p => `<div class="glass-card p-3 flex justify-between"><div><b class="block">${p.code}</b><span class="text-xs">${p.type} ${p.value}</span></div><button onclick="delPromo(${p.id})" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div>`).join(''); }; 
        // --- LOYALTY SETTINGS ---
window.fetchLoyalty = async () => {
    const { data } = await db.from('settings').select('data').eq('id', 'loyalty_program').single();
    if(data?.data) {
        document.getElementById('loyalty-type').value = data.data.type || 'fixed';
        document.getElementById('loyalty-val').value = data.data.value || 10;
    }
};

window.saveLoyaltySettings = async (btn) => {
    setBtnLoading(btn, true);
    const payload = {
        type: document.getElementById('loyalty-type').value,
        value: parseFloat(document.getElementById('loyalty-val').value)
    };
    
    const { error } = await db.from('settings').upsert({ id: 'loyalty_program', data: payload });
    
    if(error) showToast(error.message, true);
    else showToast("Loyalty Updated");
    
    setBtnLoading(btn, false);
};

        window.openPromoModal = () => { document.getElementById('p-code').value = ""; document.getElementById('p-val').value = ""; document.getElementById('p-exp').value = ""; document.getElementById('promoModal').classList.remove('hidden'); };
        window.savePromo = async (btn) => { const code = document.getElementById('p-code').value; const val = document.getElementById('p-val').value; if(!code || !val) { showToast("Missing Fields", true); return; } setBtnLoading(btn, true); const { error } = await db.from('promocodes').insert({ code: code.toUpperCase(), type: document.getElementById('p-type').value, value: parseFloat(val), expires: document.getElementById('p-exp').value }); if(error) showToast(error.message, true); else { closeModal('promoModal'); window.fetchPromos(); showToast("Promo Created"); } setBtnLoading(btn, false); }; 
        // 3. DELETE PROMO CODE
window.delPromo = async (id) => {
    // üõë Elegant Stop
    if(!await showConfirm("Revoke this promo code?")) return;

    // Proceed to Delete
    const { error } = await db.from('promocodes').delete().eq('id', id);
    if(error) {
        showToast("Error removing code", true);
    } else {
        showToast("Code removed");
        fetchPromos(); // Refresh List
    }
};
        window.fetchNewUserPromo = async () => { const { data } = await db.from('settings').select('data').eq('id', 'new_user_promo').single(); if(data && data.data)
        document.getElementById('new-user-code').value = data.data.code || 'WELCOME30'; { document.getElementById('new-user-type').value = data.data.type || 'percent'; document.getElementById('new-user-val').value = data.data.value || ''; } }; 
        window.saveNewUserPromo = async (btn) => { 
    setBtnLoading(btn, true); 
    const payload = { 
        code: document.getElementById('new-user-code').value.toUpperCase(), // New
        type: document.getElementById('new-user-type').value, 
        value: document.getElementById('new-user-val').value 
    }; 
    await db.from('settings').upsert({ id: 'new_user_promo', data: payload }); 
    showToast("New User Promo Saved"); 
    setBtnLoading(btn, false); 
};

        function checkAuth() {
    if (!db) {
        document.getElementById('preloader')?.classList.add('loaded');
        document.getElementById('auth-overlay')?.classList.remove('hidden');
        return;
    }

    db.auth.getSession()
      .then(({ data }) => {
          const session = data?.session;
          if (session) {
              document.getElementById('auth-overlay')?.classList.add('hidden');
              initAdmin();
          } else {
              document.getElementById('auth-overlay')?.classList.remove('hidden');
          }
      })
      .catch((err) => {
          console.error("checkAuth error:", err);
          document.getElementById('auth-overlay')?.classList.remove('hidden');
      })
      .finally(() => {
          document.getElementById('preloader')?.classList.add('loaded');
      });
}

document.addEventListener('visibilitychange', () => {
    if (!document.hidden && db) {
        console.log('üîÑ Page visible again ‚Üí restarting realtime');
        startOrdersRealtime();
        fetchOrders();
    }
});

// --- ADD THIS LINE AT THE VERY BOTTOM OF YOUR SCRIPT ---
// This forces a refresh every time you come back to the tab
window.addEventListener('focus', () => { fetchOrders(); });

// --- PWA & NOTIFICATION SYSTEM ---

// 1. Register Admin Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Admin SW Ready'))
            .catch(err => console.log('Admin SW Fail', err));
    });
}
// --- REPORT SYSTEM ENGINE ---

let currentReportData = { items: [], orders: [] };

window.toggleReportInputs = () => {
    const type = document.getElementById('report-type').value;
    document.getElementById('report-date').classList.toggle('hidden', type !== 'daily');
    document.getElementById('report-month').classList.toggle('hidden', type !== 'monthly');
}

window.generateReport = async () => {
    const type = document.getElementById('report-type').value;
    const dateInput = document.getElementById('report-date').value;
    const monthInput = document.getElementById('report-month').value;
    const btn = document.querySelector('button[onclick="generateReport()"]');
    
    setBtnLoading(btn, true);

    let startTime, endTime;

    // 5:00 PM - 3:30 AM Shift Logic
    if (type === 'daily') {
        if(!dateInput) { setBtnLoading(btn, false); return showToast("Pick a date", true); }
        const start = new Date(dateInput);
        start.setHours(17, 0, 0, 0); // 5 PM
        
        const end = new Date(start);
        end.setDate(end.getDate() + 1);
        end.setHours(5, 0, 0, 0); // 5 AM (Covering the 3:30 AM close)

        startTime = start.toISOString();
        endTime = end.toISOString();
    } else {
        if(!monthInput) { setBtnLoading(btn, false); return showToast("Pick a month", true); }
        const [year, month] = monthInput.split('-');
        const start = new Date(year, month - 1, 1);
        const end = new Date(year, month, 0, 23, 59, 59);
        
        startTime = start.toISOString();
        endTime = end.toISOString();
    }

    const { data: orders, error } = await db.from('orders')
        .select('*')
        .gte('created_at', startTime)
        .lte('created_at', endTime)
        .eq('status', 'Completed')
        .order('created_at', {ascending: true});

    if (error) { setBtnLoading(btn, false); return showToast("Fetch Error", true); }

    processReportData(orders);
    setBtnLoading(btn, false);
};

// REPLACE your old 'processReportData' with this one:

function processReportData(orders) {
    let totalRev = 0, totalCash = 0, totalCard = 0;
    let itemMap = {};

    // --- NEW: Smart ID Logic ---
    // We find the first ID of this specific fetched list.
    // This allows us to calculate "Order #1" for ANY date in the past.
    const isDaily = document.getElementById('report-type').value === 'daily';
    
    // If we have orders, grab the first one's ID to use as the "Base"
    // Example: If first order is ID 500, then ID 505 becomes Shift Order #6
    let reportBaseId = (orders.length > 0) ? orders[0].id : 0;

    // Generate Categories Buttons (Keep existing logic)
    const catSet = new Set(allCats); 
    document.getElementById('report-cat-buttons').innerHTML = Array.from(catSet).map(c => 
        `<button onclick="filterReportCat('${c}')" class="px-2 py-1 bg-slate-50 border border-slate-200 rounded-lg text-[10px] font-bold text-slate-500 hover:bg-orange-50 hover:text-orange-500 transition cat-btn" data-cat="${c}">${c}</button>`
    ).join('');

    // Loop Orders
    orders.forEach((o) => {
        totalRev += o.total;

        // Payment Split Logic
        if(o.payment_split) {
            totalCash += (o.payment_split.cash || 0);
            totalCard += (o.payment_split.card || 0);
        } else {
            if((o.payment_method||'').toLowerCase().includes('card')) totalCard += o.total;
            else totalCash += o.total;
        }

        // Parse Items
        const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
        items.forEach(i => {
            if(!itemMap[i.name]) itemMap[i.name] = { qty: 0, revenue: 0, cat: lookupCategory(i.name) };
            itemMap[i.name].qty += i.qty;
            itemMap[i.name].revenue += (i.qty * i.unitPrice);
        });

        // --- THE FIX ---
        // If it's a Daily Report, calc the offset so it starts at #1.
        // If it's Monthly, show the real Database ID (because #1 repeats 30 times in a month, which is confusing)
        if (isDaily) {
            o.shift_id = (o.id - reportBaseId) + 1;
        } else {
            o.shift_id = o.id; // Monthly view shows real DB IDs (e.g. 5020)
        }
    });

    // Save for filtering
    currentReportData = { 
        orders: orders,
        items: Object.entries(itemMap).map(([k, v]) => ({ name: k, ...v })).sort((a,b) => b.qty - a.qty),
        stats: { totalRev, totalCash, totalCard, count: orders.length }
    };

    // Update UI Stats
    document.getElementById('rep-total').innerText = "SR " + totalRev.toFixed(2);
    document.getElementById('rep-cash').innerText = "SR " + totalCash.toFixed(2);
    document.getElementById('rep-card').innerText = "SR " + totalCard.toFixed(2);
    document.getElementById('rep-count').innerText = orders.length;

    renderReportTables(currentReportData.items, currentReportData.orders);
}


function renderReportTables(items, orders) {
    document.getElementById('rep-items-list').innerHTML = items.map(i => `
        <tr class="hover:bg-slate-50">
            <td class="p-3">
                <div class="font-bold text-slate-700">${i.name}</div>
                <div class="text-[10px] text-slate-400">${i.cat}</div>
            </td>
            <td class="p-3 text-center font-bold bg-slate-50">${i.qty}</td>
            <td class="p-3 text-right font-bold text-slate-700">SR ${i.revenue.toFixed(2)}</td>
        </tr>
    `).join('');

    document.getElementById('rep-orders-list').innerHTML = orders.map(o => `
        <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
            <td class="p-3">
                <span class="font-black text-slate-800 bg-slate-100 px-2 py-1 rounded text-xs">#${o.shift_id}</span>
            </td>
            <td class="p-3 text-xs font-bold text-slate-500">
                ${new Date(o.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
            </td>
            <td class="p-3 text-right font-bold text-green-600">SR ${o.total.toFixed(2)}</td>
        </tr>
    `).join('');
}

window.exportReportHtml = () => {
    if(!currentReportData.orders.length) return showToast("No data to export", true);

    const dateStr = document.getElementById('report-date').value || document.getElementById('report-month').value;
    const stats = currentReportData.stats;
    const isDaily = document.getElementById('report-type').value === 'daily';

    const htmlContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TARI Report - ${dateStr}</title>
        <style>
            body { font-family: sans-serif; padding: 40px; color: #333; max-width: 800px; margin: 0 auto; }
            .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            .title { font-size: 32px; font-weight: 900; margin: 0; }
            .subtitle { color: #666; font-size: 14px; margin-top: 5px; }
            .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
            .card { background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center; }
            .card h3 { margin: 0; font-size: 24px; color: #000; }
            .card p { margin: 0 0 5px 0; font-size: 10px; text-transform: uppercase; color: #888; font-weight: bold; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
            th { text-align: left; border-bottom: 2px solid #eee; padding: 10px; font-size: 12px; text-transform: uppercase; color: #888; }
            td { border-bottom: 1px solid #eee; padding: 10px; font-size: 14px; font-weight: bold; }
            .footer { text-align: center; font-size: 12px; color: #ccc; margin-top: 50px; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1 class="title">TARI.</h1>
            <p class="subtitle">${isDaily ? 'Daily Shift' : 'Monthly'} Report | ${dateStr}</p>
        </div>
        <div class="grid">
            <div class="card"><p>Revenue</p><h3>SR ${stats.totalRev.toFixed(2)}</h3></div>
            <div class="card"><p>Cash</p><h3>SR ${stats.totalCash.toFixed(2)}</h3></div>
            <div class="card"><p>Card</p><h3>SR ${stats.totalCard.toFixed(2)}</h3></div>
            <div class="card"><p>Orders</p><h3>${stats.count}</h3></div>
        </div>
        <h3>Item Sales Breakdown</h3>
        <table>
            <thead><tr><th>Item</th><th>Category</th><th>Qty</th><th style="text-align:right">Revenue</th></tr></thead>
            <tbody>
                ${currentReportData.items.map(i => `
                <tr>
                    <td>${i.name}</td>
                    <td><span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:10px;">${i.cat}</span></td>
                    <td>${i.qty}</td>
                    <td style="text-align:right">SR ${i.revenue.toFixed(2)}</td>
                </tr>`).join('')}
            </tbody>
        </table>
        <div class="footer">Generated by TARI Admin System ‚Ä¢ ${new Date().toLocaleString()}</div>
    </body>
    </html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TARI_Report_${dateStr}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

// --- HELPER FUNCTION FOR REPORTS ---
function lookupCategory(itemName) {
    // Finds the item in your global menu list to get its category
    const found = allMenuItems.find(m => m.name === itemName);
    // If found, return category. If not found (deleted item), return "Other"
    return found ? found.category : "Other";
}

// --- REPORT FILTERING LOGIC ---
window.filterReportCat = (cat) => {
    // 1. Visual Update: Highlight the active button
    document.querySelectorAll('.cat-btn, #cat-btn-all').forEach(b => b.classList.remove('bg-slate-800', 'text-white'));
    
    if(cat === 'all') {
        document.getElementById('cat-btn-all').classList.add('bg-slate-800', 'text-white');
    } else {
        // Find the specific button for this category and highlight it
        const btn = document.querySelector(`.cat-btn[data-cat="${cat}"]`);
        if(btn) btn.classList.add('bg-slate-800', 'text-white');
    }

    // 2. Data Filtering
    if(cat === 'all') {
        // Show everything
        renderReportTables(currentReportData.items, currentReportData.orders);
    } else {
        // Filter the items list by category
        // Note: We keep the full orders list visible because orders contain mixed categories
        const filteredItems = currentReportData.items.filter(i => i.cat === cat);
        renderReportTables(filteredItems, currentReportData.orders);
    }
};
// --- CRM & MARKETING LOGIC ---
let allCustomers = [];
let selectedCustomerIds = new Set();
let waImageUrl = ""; // To store uploaded image URL

// 1. Fetch & Calculate Data
window.fetchCustomers = async () => {
    // A. Get Users
    const { data: users } = await db.from('users').select('*');
    
    // B. Get Orders (to calc stats)
    const { data: orders } = await db.from('orders').select('user_id, total, created_at');
    
    // C. Get Block List (from settings)
    const { data: settings } = await db.from('settings').select('data').eq('id', 'blocked_users').single();
    const blockedList = settings?.data?.ids || [];

    // D. Merge Data
    const stats = {};
    orders.forEach(o => {
        if(!stats[o.user_id]) stats[o.user_id] = { count: 0, spent: 0, lastOrder: 0 };
        stats[o.user_id].count++;
        stats[o.user_id].spent += o.total;
        const time = new Date(o.created_at).getTime();
        if(time > stats[o.user_id].lastOrder) stats[o.user_id].lastOrder = time;
    });

    allCustomers = users.map(u => ({
        ...u,
        orders: stats[u.id]?.count || 0,
        spent: stats[u.id]?.spent || 0,
        last_active: stats[u.id]?.lastOrder || new Date(u.created_at).getTime(),
        isBlocked: blockedList.includes(u.id)
    }));

    renderCustomerTable();
};

// 2. Render Table
window.renderCustomerTable = () => {
    const sort = document.getElementById('cust-sort').value;
    const search = document.getElementById('cust-search').value.toLowerCase();
    
    // Sort
    let list = [...allCustomers];
    if(sort === 'newest') list.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    if(sort === 'spend') list.sort((a,b) => b.spent - a.spent);
    if(sort === 'orders') list.sort((a,b) => b.orders - a.orders);
    if(sort === 'name') list.sort((a,b) => (a.name||"").localeCompare(b.name||""));

    // Filter
    if(search) list = list.filter(u => (u.name||"").toLowerCase().includes(search) || (u.phone||"").includes(search));

    const tbody = document.getElementById('cust-list');
    tbody.innerHTML = list.map(u => `
        <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0 ${u.isBlocked ? 'bg-red-50/50' : ''}">
            <td class="p-4">
                <input type="checkbox" onchange="toggleCustSelect('${u.id}')" class="cust-check accent-green-500 w-4 h-4 cursor-pointer" ${selectedCustomerIds.has(u.id) ? 'checked' : ''}>
            </td>
            <td class="p-4">
                <div class="font-bold text-slate-800">${u.name || 'Guest'}</div>
                <div class="text-[10px] text-slate-400">Joined: ${new Date(u.created_at).toLocaleDateString()}</div>
            </td>
            <td class="p-4 font-mono text-xs text-slate-600">${u.phone || '-'}</td>
            <td class="p-4 text-center font-bold text-slate-700">${u.orders}</td>
            <td class="p-4 text-right font-black text-green-600">SR ${u.spent.toFixed(2)}</td>
            <td class="p-4 text-center">
                ${u.isBlocked 
                    ? '<span class="px-2 py-1 bg-red-100 text-red-600 rounded-lg text-[10px] font-bold">BLOCKED</span>' 
                    : '<span class="px-2 py-1 bg-green-50 text-green-600 rounded-lg text-[10px] font-bold">ACTIVE</span>'}
            </td>
            <td class="p-4 text-center">
                <button onclick="toggleBlockUser('${u.id}', ${!u.isBlocked})" class="w-8 h-8 rounded-lg flex items-center justify-center transition ${u.isBlocked ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-400 hover:text-red-500 hover:bg-red-50'}">
                    <i class="fa-solid ${u.isBlocked ? 'fa-unlock' : 'fa-ban'}"></i>
                </button>
            </td>
        </tr>
    `).join('');
};

// 3. Selection Logic
window.toggleCustSelect = (id) => {
    if(selectedCustomerIds.has(id)) selectedCustomerIds.delete(id);
    else selectedCustomerIds.add(id);
    updateOfferBtn();
};

window.toggleSelectAll = (checkbox) => {
    const checks = document.querySelectorAll('.cust-check');
    checks.forEach(c => c.checked = checkbox.checked);
    
    if(checkbox.checked) {
        // Add all currently visible IDs
        // Note: In a real app, you might want to select filtered items only
        allCustomers.forEach(u => selectedCustomerIds.add(u.id));
    } else {
        selectedCustomerIds.clear();
    }
    updateOfferBtn();
};

function updateOfferBtn() {
    const btn = document.getElementById('btn-send-offer');
    const count = document.getElementById('sel-count');
    
    if(selectedCustomerIds.size > 0) {
        btn.classList.remove('hidden');
        count.innerText = selectedCustomerIds.size;
    } else {
        btn.classList.add('hidden');
    }
}

// 4. Block/Unblock Logic
window.toggleBlockUser = async (uid, blockStatus) => {
    if(!await showConfirm(blockStatus ? "Block this user?" : "Unblock this user?")) return;

    // Fetch current list
    const { data } = await db.from('settings').select('data').eq('id', 'blocked_users').single();
    let list = data?.data?.ids || [];

    if(blockStatus) {
        if(!list.includes(uid)) list.push(uid);
    } else {
        list = list.filter(id => id !== uid);
    }

    await db.from('settings').upsert({ id: 'blocked_users', data: { ids: list } });
    showToast(blockStatus ? "User Blocked" : "User Unblocked");
    fetchCustomers(); // Refresh UI
};

// --- WHATSAPP CAMPAIGN LOGIC ---

window.openOfferModal = () => {
    const container = document.getElementById('recipient-chips');
    container.innerHTML = '';
    
    // Add selected users as chips
    selectedCustomerIds.forEach(id => {
        const user = allCustomers.find(u => u.id === id);
        if(user && user.phone) {
            addChip(user.phone, user.name);
        }
    });

    document.getElementById('offerModal').classList.remove('hidden');
};

function addChip(phone, name="User") {
    const container = document.getElementById('recipient-chips');
    const div = document.createElement('div');
    div.className = "bg-white border border-slate-200 rounded-lg px-2 py-1 flex items-center gap-2 shadow-sm animate-[scaleIn_0.2s]";
    div.innerHTML = `
        <span class="text-[10px] font-bold text-slate-700">${name}</span>
        <span class="text-[9px] text-slate-400">${phone}</span>
        <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
    `;
    div.dataset.phone = phone; // Store for sending
    container.appendChild(div);
}

window.addManualRecipient = () => {
    const input = document.getElementById('manual-phone');
    const val = input.value.replace(/\D/g, ''); // Clean number
    if(val.length < 9) return showToast("Invalid Number", true);
    
    addChip(val, "Manual");
    input.value = "";
};

window.insertTag = (tag) => {
    const txt = document.getElementById('wa-msg');
    txt.value += ` ${tag} `;
    txt.focus();
};

// Image Handling
window.previewWaImg = (input) => {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('wa-img-preview').src = e.target.result;
            document.getElementById('wa-img-preview').classList.remove('hidden');
            document.getElementById('btn-rm-wa-img').classList.remove('hidden');
            // In real app, you'd upload this to Supabase Storage here and get URL
             uploadWaImage(input.files[0]);
        };
        reader.readAsDataURL(input.files[0]);
    }
};

async function uploadWaImage(file) {
    showToast("Uploading Image...", false);
    const name = `campaign-${Date.now()}.png`;
    const { data, error } = await db.storage.from('images').upload(name, file);
    if(data) {
        waImageUrl = db.storage.from('images').getPublicUrl(name).data.publicUrl;
        showToast("Image Ready");
    }
}

window.removeWaImg = () => {
    waImageUrl = "";
    document.getElementById('wa-img-preview').classList.add('hidden');
    document.getElementById('btn-rm-wa-img').classList.add('hidden');
    document.getElementById('wa-img-input').value = "";
};

// --- SENDING ENGINE (THE API PART) ---
// --- REAL WHATSAPP SENDER (WaSenderAPI) ---
window.sendCampaign = async () => {
    const btn = document.getElementById('btn-send-wa');
    setBtnLoading(btn, true);

    const msgInput = document.getElementById('wa-msg').value;
    if(!msgInput) { setBtnLoading(btn, false); return showToast("Enter a message", true); }

    // 1. Gather Numbers
    const recipients = [];
    document.getElementById('recipient-chips').childNodes.forEach(chip => {
        if(chip.dataset && chip.dataset.phone) {
            // Clean phone number: Remove '+' or spaces, ensure it matches API format
            let p = chip.dataset.phone.replace(/\D/g, ''); 
            recipients.push(p);
        }
    });

    if(recipients.length === 0) { setBtnLoading(btn, false); return showToast("No recipients", true); }

    // 2. Prepare API Details
    const API_URL = "https://wasenderapi.com/api/send-message";
    const API_TOKEN = "8cf8551148413371fb7c0274b209a01eda0dee27d934233f906d2c4d0dfd120d";

    let successCount = 0;
    let failCount = 0;

    // 3. Loop & Send (Sequential to prevent rate limits)
    for (const phone of recipients) {
        try {
            // Construct Message
            // If an image was uploaded, we append its URL to the text
            let finalMsg = msgInput;
            if(waImageUrl) {
                finalMsg += `\n\n${waImageUrl}`; 
            }

            // Replace Tags (e.g. {name} -> Guest)
            // Note: For bulk campaigns, personalized names usually require individual logic.
            // Here we use a generic placeholder since we are looping raw numbers.
            finalMsg = finalMsg.replace('{name}', 'Customer');

            const payload = {
                "to": phone,
                "text": finalMsg
            };

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    "Authorization": `Bearer ${API_TOKEN}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if(res.ok) successCount++;
            else failCount++;

            // Tiny delay to be safe
            await new Promise(r => setTimeout(r, 200));

        } catch (e) {
            console.error("Sending Error:", e);
            failCount++;
        }
    }

    // 4. Save to History Log
    const logEntry = {
        date: new Date().toISOString(),
        msg: msgInput,
        recipients: recipients.length,
        hasImage: !!waImageUrl,
        status: successCount > 0 ? 'Sent' : 'Failed',
        details: `${successCount} Sent, ${failCount} Failed`
    };
    
    // Update DB History
    const { data } = await db.from('settings').select('data').eq('id', 'msg_history').single();
    const history = data?.data?.logs || [];
    history.unshift(logEntry);
    
    // Keep log size manageable (Max 50)
    if(history.length > 50) history.pop();

    await db.from('settings').upsert({ id: 'msg_history', data: { logs: history } });

    // 5. Cleanup UI
    showToast(`Campaign Done: ${successCount} Sent`);
    closeModal('offerModal');
    
    // Clear Selection
    selectedCustomerIds.clear();
    renderCustomerTable();
    updateOfferBtn();
    
    setBtnLoading(btn, false);
};


// --- HISTORY LOGIC ---
window.openMsgHistory = async () => {
    const { data } = await db.from('settings').select('data').eq('id', 'msg_history').single();
    const logs = data?.data?.logs || [];
    
    const list = document.getElementById('msg-history-list');
    if(logs.length === 0) {
        list.innerHTML = `<div class="text-center text-slate-400 py-10">No campaigns yet</div>`;
    } else {
        list.innerHTML = logs.map(l => `
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-400">${new Date(l.date).toLocaleString()}</span>
                    <span class="bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">${l.status}</span>
                </div>
                <p class="text-sm font-bold text-slate-700 mb-2">"${l.msg}"</p>
                <div class="flex gap-4 text-xs text-slate-500">
                    <span><i class="fa-solid fa-users mr-1"></i> ${l.recipients} Users</span>
                    ${l.hasImage ? '<span><i class="fa-solid fa-image mr-1"></i> Image Attached</span>' : ''}
                </div>
            </div>
        `).join('');
    }
    
    document.getElementById('historyMsgModal').classList.remove('hidden');
};

// --- 4. OPTIMIZED WATCHDOG ---
// Runs every 60 seconds to ensure connection is actually alive
setInterval(() => {
    if (!ordersChannel || ordersChannel.state === 'closed' || ordersChannel.state === 'errored') {
        console.warn("üöë Watchdog detected dead line. Restarting...");
        startOrdersRealtime();
    } else {
        // Even if connected, silently fetch data just in case socket hung
        fetchOrders();
    }
}, 60000);

// Only aggressive refresh if tab was hidden for > 1 minute
let lastVisible = Date.now();
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'visible') {
        const now = Date.now();
        // Only force reconnect if we've been gone a while
        if (now - lastVisible > 60000) {
            console.log("üëÅÔ∏è Tab Woke Up - Checking Connection");
            fetchOrders();
            if(!ordersChannel || ordersChannel.state !== 'joined') {
                startOrdersRealtime();
            }
        }
        lastVisible = now;
    }
});





        // Start App
        loadSupabaseLib();
    </script>
</body>
</html>
